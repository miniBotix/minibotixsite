<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MiniBotix ¬∑ Products Shop</title>
  <link rel="icon" href="file.svg" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071126;
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.03);
      --accent1: #007bff;
      --accent2: #00d4ff;
      --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;color:#fff;background:var(--bg);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}

    header.nav{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 22px;background:rgba(0,0,0,0.4);backdrop-filter:blur(6px);z-index:90;box-shadow:0 2px 12px rgba(0,0,0,0.6)}
    .nav-left{display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .brand img{height:36px;width:36px;border-radius:6px}
    nav.main-nav{display:flex;gap:22px;align-items:center}
    nav.main-nav a{font-weight:500;color:rgba(255,255,255,0.9);padding:6px 6px}
    .back-btn{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.9);cursor:pointer}
    .user-pill{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .avatar{height:36px;width:36px;border-radius:50%;background:#223;display:inline-flex;align-items:center;justify-content:center}

    .hero{padding:110px 22px 40px 22px}
    .hero-card{max-width:1100px;margin:0 auto;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:44px;border-radius:14px;box-shadow:0 30px 60px rgba(3,7,20,0.6)}
    .eyebrow{display:inline-block;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;margin-bottom:16px;color:#aee9ff;font-weight:600}
    .hero h1{font-size:44px;margin:6px 0 12px;line-height:1.03}
    .hero p{color:rgba(255,255,255,0.85);margin-bottom:18px;max-width:900px}
    .hero-actions{display:flex;gap:14px}
    .btn-primary{background:var(--accent-grad);padding:10px 16px;border-radius:999px;border:none;color:#fff;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,0.45)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}

    .section{padding:40px 22px 90px}
    .container{max-width:1100px;margin:0 auto}
    h2{font-size:24px;margin-bottom:10px}
    .lead{color:rgba(255,255,255,0.8);margin-bottom:14px}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px}
    .card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);transition:transform .22s, box-shadow .22s}
    .card:hover{transform:translateY(-8px);box-shadow:0 18px 40px rgba(0,0,0,0.5)}
    .card .img{height:140px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;margin-bottom:12px}
    .price{font-weight:700;color:var(--accent2);margin-right:12px}
    .card-actions{display:flex;gap:10px;align-items:center;margin-top:12px}

    .cart-bubble{position:relative}
    .cart-count{position:absolute;right:-8px;top:-8px;background:#ff5c5c;color:#fff;height:20px;width:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px}

    @media (max-width:880px){
      nav.main-nav{display:none}
      .hero h1{font-size:28px}
    }

    .muted{color:rgba(255,255,255,0.7);font-size:14px}
    .small{font-size:13px;color:rgba(255,255,255,0.7)}

    .mini-toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 22px; padding: 10px 14px; border-radius: 8px; z-index: 9999; font-weight:600 }
  </style>
</head>
<body>

  <header class="nav">
    <div style="display:flex;align-items:center;gap:18px">
      <div class="back-btn" onclick="location.href='index.html'">‚Üê Back</div>
      <div class="brand">
        <img src="file.svg" alt="MiniBotix">
        <div style="line-height:1">
          <div style="font-weight:700">MiniBotix</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.6)">Products Shop</div>
        </div>
      </div>
    </div>

    <nav class="main-nav" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="courses.html">Courses</a>
      <a href="products.html" style="text-decoration:underline">Products</a>
      <a href="componentshop.html">Components</a>
      <a href="projects.html">Projects</a>
      <a href="apps.html">Free Apps</a>
      <a href="contact.html">Contact</a>
    </nav>

    <div style="display:flex;align-items:center;gap:12px">
      <div id="userArea" class="user-pill">
        <div id="signedOut" style="display:flex;gap:8px;align-items:center">
          <button id="openAuth" class="btn-ghost" title="Sign In">Sign In</button>
        </div>
        <div id="signedIn" style="display:none;align-items:center;gap:10px">
          <div id="profileName" style="font-weight:600"></div>
          <div class="avatar" id="avatar">M</div>
          <div class="cart-bubble" title="Cart">
            <button id="openCart" class="btn-ghost" title="Open Cart">üõí</button>
            <div id="cartCount" class="cart-count" style="display:none">0</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="hero-card container">
      <div class="eyebrow">MiniBotix ¬∑ Products ¬∑ Top Quality</div>
      <h1>High-Quality Products for Your Projects</h1>
      <p class="lead">Browse our curated selection of products for agriculture and engineering projects. Add to cart and place an order easily.</p>
      <div class="hero-actions">
        <button class="btn-primary" id="toProductsBtn">Shop All Products</button>
        <button class="btn-ghost" id="contactBtn">Contact Support</button>
      </div>
    </div>
  </section>

  <section id="productsSection" class="section">
    <div class="container">
      <h2>Available Products</h2>
      <p class="lead">Click Add to Cart to collect items. Cart persists across pages for signed-in users.</p>
      <div id="productsGrid" class="grid" aria-live="polite"></div>
    </div>
  </section>

  <footer>
    <div class="container">
      <div style="margin-bottom:8px">MiniBotix ¬∑ Learn ¬∑ Build ¬∑ Innovate</div>
      <small>¬© 2025 MiniBotix</small>
    </div>
  </footer>

  <!-- AUTH & CART modals remain unchanged -->
  <div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:999">
    <!-- ... same as componentshop.html ... -->
  </div>

  <div id="cartModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:999">
    <!-- ... same as componentshop.html ... -->
  </div>

  <script type="module">
    const firebaseConfig = { /* same config as componentshop.html */ };
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykykXjz__of04EMewJIBzAljen2vl1aR7j1BVgPSptM1tpq_rvXCcmXOBlx1LApUGg/exec';
    const ADMIN_EMAIL = 'minibotix@gmail.com';

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const openAuthBtn = document.getElementById('openAuth');
    const authModal = document.getElementById('authModal');
    const signedOut = document.getElementById('signedOut');
    const signedIn = document.getElementById('signedIn');
    const profileName = document.getElementById('profileName');
    const avatar = document.getElementById('avatar');
    const cartCount = document.getElementById('cartCount');
    const openCart = document.getElementById('openCart');
    const cartModal = document.getElementById('cartModal');
    const cartItemsContainer = document.getElementById('cartItemsContainer');
    const cartTotalEl = document.getElementById('cartTotal');
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    const deliveryAddress = document.getElementById('deliveryAddress');

    const toProductsBtn = document.getElementById('toProductsBtn');
    const contactBtn = document.getElementById('contactBtn');

    toProductsBtn.addEventListener('click', ()=>{ document.getElementById('productsSection').scrollIntoView({behavior:'smooth'}); });
    contactBtn.addEventListener('click', ()=>{ window.location.href = 'contact.html'; });

    document.getElementById('loginBtn').addEventListener('click', emailLogin);
    document.getElementById('registerBtn').addEventListener('click', emailRegister);
    document.getElementById('googleSignBtn').addEventListener('click', googleSignIn);
    openAuthBtn.addEventListener('click', ()=> authOpen());

    function authOpen(){ authModal.style.display = 'flex'; }
    function authClose(){ authModal.style.display = 'none'; }
    function showRegister(){ document.getElementById('loginView').style.display='none'; document.getElementById('registerView').style.display='block'; }
    function showLogin(){ document.getElementById('loginView').style.display='block'; document.getElementById('registerView').style.display='none'; }

    let products = [];
    let cart = [];
    let currentUser = null;

    function escapeHtml(s){ if(s===undefined || s===null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function showToast(msg, isErr=false){ const div = document.createElement('div'); div.className='mini-toast'; div.style.background = isErr ? '#ff6b6b' : 'linear-gradient(90deg,#00c6ff,#0066ff)'; div.style.color = isErr ? '#fff' : '#021'; div.textContent = msg; document.body.appendChild(div); setTimeout(()=>{ div.style.transition='all .4s'; div.style.opacity='0'; div.style.transform='translateY(8px)'; }, 2600); setTimeout(()=>div.remove(),3000); }

    async function loadProducts(){
      try{
        const res = await fetch('products.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('products.json not found (HTTP ' + res.status + ')');
        const raw = await res.json();
        products = (Array.isArray(raw) ? raw : []).map(p => ({
          id: p.id || p._id || (p.name ? p.name.replace(/\s+/g,'_').toLowerCase() : 'p_'+Math.random().toString(36).slice(2,9)),
          name: p.name || p.title || p.productName || 'Unnamed',
          price: Number(p.price || 0),
          description: p.description || p.desc || '',
          image: p.image || p.img || ''
        }));
      }catch(e){
        console.error('Failed to load products.json', e);
        products = [{ id:'_err', name:'Unable to load products.json', price:0, description:'Ensure products.json exists', image:'' }];
      }
      renderProducts();
    }

    function renderProducts(){
      const grid = document.getElementById('productsGrid');
      grid.innerHTML = '';
      products.forEach(p=>{
        const card = document.createElement('div');
        card.className = 'card';
        const imgSrc = p.image || ('https://via.placeholder.com/320x140?text='+encodeURIComponent(p.name));
        const title = p.name || 'Unknown';
        const price = Number(p.price || 0);
        const desc = p.description || '';
        card.innerHTML = `
          <div class="img"><img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(title)}" style="max-width:100%;max-height:100%;object-fit:contain"></div>
          <div style="font-weight:700;font-size:16px;margin-bottom:6px">${escapeHtml(title)}</div>
          <div class="small muted" style="margin-bottom:8px">${escapeHtml(desc)}</div>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div class="price">‚Çπ${Number(price).toLocaleString()}</div>
            <div class="card-actions">
              <button class="btn-ghost" data-id="${escapeHtml(p.id)}" data-action="details">Details</button>
              <button class="btn-primary" data-id="${escapeHtml(p.id)}" data-action="add">Add to Cart</button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });

      grid.querySelectorAll('[data-action="add"]').forEach(btn=>{ btn.addEventListener('click', ()=> addToCart(btn.getAttribute('data-id')) ); });
      grid.querySelectorAll('[data-action="details"]').forEach(btn=>{ btn.addEventListener('click', ()=>{ const p = products.find(x=>x.id===btn.getAttribute('data-id')); if(!p) return showToast('Product not found', true); alert(`${p.name}\n\nPrice: ‚Çπ${p.price}\n\n${p.description}`); }); });
    }

    function saveCartLocally(){ localStorage.setItem('mb_cart', JSON.stringify(cart)); renderCartUI(); renderCartCount(); }
    function loadCartLocally(){ const raw = localStorage.getItem('mb_cart'); if(raw){ try{ cart = JSON.parse(raw); }catch(e){ cart=[]; } } renderCartUI(); renderCartCount(); }

    function addToCart(id){ const p = products.find(x=>x.id===id); if(!p) return showToast('Product not found', true); const existing = cart.find(c=>c.id===id); if(existing) existing.qty+=1; else cart.push({ id:id, title:p.name||'Unknown', price:Number(p.price||0), qty:1, img:p.image||'' }); saveCartLocally(); showToast('Added '+(p.name||p.title)); if(currentUser) persistCartToFirestore(); }
    function renderCartUI(){ cartItemsContainer.innerHTML=''; if(cart.length===0){ cartItemsContainer.innerHTML='<div class="muted">Your cart is empty</div>'; cartTotalEl.textContent='‚Çπ0'; return; } let total=0; cart.forEach(it=>{ total+=it.price*it.qty; const el=document.createElement('div'); el.className='order-row'; el.innerHTML=`<div style="display:flex;gap:12px;align-items:center"><div style="width:48px;height:48px;border-radius:8px;background:#0b1220;display:flex;align-items:center;justify-content:center">${it.img?'<img src="'+escapeHtml(it.img)+'" style="max-height:40px"/>':'<svg width="28" height="28" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="4" fill="#0f1724"/></svg>'}</div><div style="flex:1"><div style="font-weight:700">${escapeHtml(it.title)}</div><div class="small muted">‚Çπ${it.price} √ó ${it.qty}</div></div><div style="display:flex;gap:8px;align-items:center"><button class="btn-ghost" data-id="${escapeHtml(it.id)}" data-op="decrease">‚àí</button><button class="btn-ghost" data-id="${escapeHtml(it.id)}" data-op="increase">+</button><button class="btn-ghost" data-id="${escapeHtml(it.id)}" data-op="remove">Remove</button></div></div>`; cartItemsContainer.appendChild(el); });
      cartItemsContainer.querySelectorAll('[data-op]').forEach(b=>{ b.addEventListener('click', ()=>{ const id=b.getAttribute('data-id'); const op=b.getAttribute('data-op'); if(op==='decrease') decreaseQty(id); else if(op==='increase') increaseQty(id); else if(op==='remove') removeItem(id); }); });
      cartTotalEl.textContent='‚Çπ'+total.toLocaleString();
    }
    function increaseQty(id){ const it=cart.find(x=>x.id===id); if(it){ it.qty++; saveCartLocally(); if(currentUser) persistCartToFirestore(); } }
    function decreaseQty(id){ const it=cart.find(x=>x.id===id); if(it){ it.qty=Math.max(1,it.qty-1); saveCartLocally(); if(currentUser) persistCartToFirestore(); } }
    function removeItem(id){ cart=cart.filter(x=>x.id!==id); saveCartLocally(); if(currentUser) persistCartToFirestore(); }
    function renderCartCount(){ const count=cart.reduce((s,i)=>s+i.qty,0); if(count>0){ cartCount.style.display='flex'; cartCount.textContent=count; } else cartCount.style.display='none'; }

    async function persistCartToFirestore(){ try{ if(!currentUser) return; const userMetaRef=doc(db,'users',currentUser.uid,'meta','cartSnapshot'); await setDoc(userMetaRef,{cart,total:cart.reduce((s,i)=>s+i.price*i.qty,0),updatedAt:serverTimestamp()}); const userRef=doc(db,'users',currentUser.uid); await setDoc(userRef,{name:currentUser.displayName||currentUser.email.split('@')[0],email:currentUser.email},{merge:true}); }catch(e){ console.warn('persistCartToFirestore failed',e);} }

    async function emailLogin(){ const email=document.getElementById('loginEmail').value.trim(); const pass=document.getElementById('loginPass').value; try{ await signInWithEmailAndPassword(auth,email,pass); authClose(); showToast('Signed in'); }catch(e){ console.error(e); showToast('Login failed: '+(e.message||e),true); } }
    async function emailRegister(){ const name=document.getElementById('regName').value.trim(); const phone=document.getElementById('regPhone').value.trim(); const email=document.getElementById('regEmail').value.trim(); const pass=document.getElementById('regPass').value; if(pass.length<6){ showToast('Password must be at least 6 chars',true); return; } try{ const cred=await createUserWithEmailAndPassword(auth,email,pass); await updateProfile(cred.user,{displayName:name}); await setDoc(doc(db,'users',cred.user.uid),{name,email,phone,createdAt:serverTimestamp()},{merge:true}); authClose(); showToast('Account created'); }catch(e){ console.error(e); showToast('Register failed: '+(e.message||e),true); } }
    async function googleSignIn(){ const provider=new GoogleAuthProvider(); try{ const result=await signInWithPopup(auth,provider); const user=result.user; await setDoc(doc(db,'users',user.uid),{name:user.displayName,email:user.email,photoURL:user.photoURL,lastSignIn:serverTimestamp()},{merge:true}); authClose(); showToast('Signed in with Google'); }catch(e){ console.error(e); showToast('Google sign-in failed: '+(e.message||e),true); } }
    async function doSignOut(){ try{ await signOut(auth); showToast('Signed out'); }catch(e){ console.warn(e); } }

    onAuthStateChanged(auth,async (user)=>{ currentUser=user||null; if(user){ signedOut.style.display='none'; signedIn.style.display='flex'; profileName.textContent=user.displayName?user.displayName.split(' ')[0]:(user.email?user.email.split('@')[0]:'User'); avatar.textContent=(user.displayName?user.displayName[0]:(user.email?user.email[0]:'U')).toUpperCase(); try{ const cs=await getDoc(doc(db,'users',user.uid,'meta','cartSnapshot')); if(cs&&cs.exists()){ const data=cs.data(); if(Array.isArray(data.cart)&&data.cart.length>0){ cart=data.cart; saveCartLocally(); } else { const local=localStorage.getItem('mb_cart'); if(local){ cart=JSON.parse(local); await persistCartToFirestore(); } } } else { const local=localStorage.getItem('mb_cart'); if(local) cart=JSON.parse(local); } }catch(e){ console.warn('Load user cart failed',e); const local=localStorage.getItem('mb_cart'); if(local) cart=JSON.parse(local); } renderCartCount(); renderCartUI(); } else { signedOut.style.display='flex'; signedIn.style.display='none'; profileName.textContent=''; avatar.textContent='M'; const local=localStorage.getItem('mb_cart'); cart=local?JSON.parse(local):[]; renderCartCount(); renderCartUI(); } });

    openCart.addEventListener('click',()=>{ cartModal.style.display='flex'; renderCartUI(); });
    function cartClose(){ cartModal.style.display='none'; }

    placeOrderBtn.addEventListener('click', placeOrder);
    async function placeOrder(){ 
      if(!currentUser){ showToast('Please sign in to place an order',true); return; }
      if(cart.length===0){ showToast('Cart empty',true); return; }
      if((deliveryAddress.value||'').trim().length<3){ showToast('Enter delivery address',true); return; }
      const cleanItems=cart.map(i=>({id:i.id||('pid_'+Math.random().toString(36).slice(2,9)),title:i.title||'Unknown',price:Number(i.price||0),qty:Number(i.qty||1),img:i.img||''}));
      const orderTotal=cleanItems.reduce((s,i)=>s+i.price*i.qty,0);
      const orderObj={ uid:currentUser.uid, userName:currentUser.displayName||(currentUser.email?currentUser.email.split('@')[0]:''), userEmail:currentUser.email||'', items:cleanItems, total:orderTotal, deliveryAddress:(deliveryAddress.value||'').trim(), status:'pending', createdAt:serverTimestamp() };
      try{ const ordersRef=collection(db,'orders'); await addDoc(ordersRef,orderObj); showToast('Order placed'); cart=[]; saveCartLocally(); await persistCartToFirestore(); cartClose(); }catch(e){ console.error(e); showToast('Failed to place order',true); } }

    loadProducts();
    loadCartLocally();
  </script>
</body>
</html>
