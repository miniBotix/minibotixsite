<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniBotix · Python Beginner — Course</title>
<link rel="icon" href="file.svg" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071126;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --accent1: #007bff;
    --accent2: #00d4ff;
    --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;color:#fff;background:var(--bg);-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}

  header.nav{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 22px;background:rgba(0,0,0,0.5);backdrop-filter:blur(6px);z-index:90}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
  .brand img{height:36px;width:36px;border-radius:6px}
  .back-btn{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.9);cursor:pointer}
  .top-actions{display:flex;gap:12px;align-items:center}

  .hero{padding:110px 22px 28px 22px}
  .hero-card{max-width:1100px;margin:0 auto;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:34px;border-radius:14px;box-shadow:0 30px 60px rgba(3,7,20,0.6)}
  .eyebrow{display:inline-block;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;margin-bottom:16px;color:#aee9ff;font-weight:600}
  .hero h1{font-size:36px;margin:6px 0 12px;line-height:1.03}
  .hero p{color:rgba(255,255,255,0.85);margin-bottom:12px;max-width:900px}

  .progress-pill{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .btn-primary{background:var(--accent-grad);padding:10px 16px;border-radius:999px;border:none;color:#fff;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,0.45)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}

  .section{padding:28px 22px 90px}
  .container{max-width:1100px;margin:0 auto}
  h2{font-size:22px;margin-bottom:10px}
  .lead{color:rgba(255,255,255,0.8);margin-bottom:14px}

  .stage-panel{display:grid;grid-template-columns:1fr 440px;gap:18px;align-items:start}
  .lesson-card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .lesson-title{font-size:18px;font-weight:700;margin-bottom:8px}
  .lesson-content{color:rgba(255,255,255,0.9);line-height:1.6}

  .runner-card{background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .editor{width:100%;height:240px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#06101a;padding:10px;color:#fff;font-family:monospace;resize:vertical;overflow:auto}
  .outbox{min-height:88px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#050816;padding:10px;color:#d6f7ff;font-family:monospace;font-size:13px;white-space:pre-wrap;overflow:auto}

  .quiz{margin-top:12px}
  .q{margin-bottom:8px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:rgba(255,255,255,0.01)}
  .answers{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .answer-btn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;cursor:pointer;text-align:left}

  .stage-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .muted{color:rgba(255,255,255,0.65);font-size:13px}

  .stages-list{display:flex;gap:8px;overflow:auto;padding:8px;margin-bottom:14px}
  .stage-pill{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;white-space:nowrap}
  .stage-pill.locked{opacity:0.35;cursor:not-allowed}

  @media (max-width:980px){
    .stage-panel{grid-template-columns:1fr}
    .runner-card{order:2}
  }

  /* small toast */
  .mini-toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 22px; padding: 10px 14px; border-radius: 8px; z-index: 9999; font-weight:600 }
</style>
</head>
<body>

<header class="nav">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="back-btn" onclick="location.href='courses.html'">← Back</div>
    <div class="brand">
      <img src="file.svg" alt="MiniBotix">
      <div style="line-height:1">
        <div style="font-weight:700">MiniBotix</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.6)">Python · Beginner</div>
      </div>
    </div>
  </div>

  <div class="top-actions">
    <div id="progressPill" class="progress-pill">Progress: <span id="progressText">Stage 0 / 10</span></div>
    <div id="userArea" style="display:flex;align-items:center;gap:10px">
      <div id="userName" style="font-weight:600;color:rgba(255,255,255,0.9)">Guest</div>
      <button id="signBtn" class="btn-ghost">Sign In</button>
    </div>
  </div>
</header>

<section class="hero">
  <div class="hero-card container">
    <div class="eyebrow">MiniBotix · Courses · Python</div>
    <h1>Python for Engineers — Beginner Track</h1>
    <p class="lead">Ten short stages each with a lesson, code exercise and a short quiz. Run the code in your browser. Pass a stage (≥ 60%) to unlock the next one. Progress is saved to our Google Sheet so you can resume anytime.</p>
    <div style="display:flex;gap:12px;align-items:center">
      <button class="btn-primary" id="startBtn">Start / Resume</button>
      <button class="btn-ghost" id="overviewBtn">Course Overview</button>
    </div>
  </div>
</section>

<section class="section">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2>Course Stages</h2>
      <div class="muted">Complete stages one by one. Scores saved to your account.</div>
    </div>

    <div class="stages-list" id="stagesList"></div>

    <div id="mainStageArea" class="stage-panel">
      <div class="lesson-card">
        <div class="lesson-title" id="lessonTitle">Welcome</div>
        <div class="lesson-content" id="lessonContent">
          <p>Press "Start" to begin. Sign in to save progress and resume. Each stage has short examples and a code exercise to run. Quizzes are 5 simple multiple-choice questions designed to confirm your understanding.</p>
        </div>

        <div style="margin-top:12px">
          <strong>Stage status:</strong> <span id="stageStatus" class="muted">Not started</span>
        </div>
      </div>

      <div class="runner-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:700">Code Runner</div>
          <div style="display:flex;gap:8px">
            <button id="runBtn" class="btn-ghost">Run</button>
            <button id="resetCodeBtn" class="btn-ghost">Reset</button>
            <button id="showQuizBtn" class="btn-ghost">Show Quiz</button>
          </div>
        </div>

        <textarea id="editor" class="editor" spellcheck="false"></textarea>
        <div style="margin-top:8px;font-weight:700">Output</div>
        <div id="output" class="outbox">Program output will appear here</div>

        <div class="quiz" id="quizArea" style="display:none"></div>

        <div class="stage-footer">
          <div>
            <button id="submitQuizBtn" class="btn-primary">Submit Quiz</button>
            <button id="markCompleteBtn" class="btn-ghost">Mark Complete (if quiz passed)</button>
          </div>
          <div class="muted">Stage Score: <span id="stageScore">—</span></div>
        </div>
      </div>
    </div>

  </div>
</section>

<footer style="padding-bottom:40px">
  <div class="container" style="text-align:center">
    <div style="margin-bottom:8px">MiniBotix · Learn · Build · Innovate</div>
    <small>© 2025 MiniBotix</small>
  </div>
</footer>

<!-- Skulpt (in-browser Python) -->
<script src="https://cdn.jsdelivr.net/gh/skulpt/skulpt/dist/skulpt.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/skulpt/skulpt/dist/skulpt-stdlib.js"></script>

<!-- Firebase (v12 modular) -->
<script type="module">
  // -------- CONFIG --------
  const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6CWzYJKcHruIP1mAv7ypqUsHTIUPsyhheu_68uSMH5jlqiIvvU8Ib57XXF6-C1HVA/exec';
  const COURSE_NAME = 'Python Beginner';
  const PASS_PERCENT = 60;

  // Replace with your project's firebaseConfig if needed
  const firebaseConfig = {
    apiKey: "AIzaSyDWmliHHP7UR1pmM6CNjY6o_NvF-hYJWpY",
    authDomain: "minibotix-a1b9a.firebaseapp.com",
    projectId: "minibotix-a1b9a",
    storageBucket: "minibotix-a1b9a.firebasestorage.app",
    messagingSenderId: "771169717230",
    appId: "1:771169717230:web:44848d73e548d0e0f8dcff",
    measurementId: "G-JQKFSBN4WP"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // -------- UI REFS --------
  const signBtn = document.getElementById('signBtn');
  const userNameEl = document.getElementById('userName');
  const startBtn = document.getElementById('startBtn');
  const overviewBtn = document.getElementById('overviewBtn');

  const stagesListEl = document.getElementById('stagesList');
  const lessonTitleEl = document.getElementById('lessonTitle');
  const lessonContentEl = document.getElementById('lessonContent');
  const stageStatusEl = document.getElementById('stageStatus');
  const progressTextEl = document.getElementById('progressText');

  const editorEl = document.getElementById('editor');
  const runBtn = document.getElementById('runBtn');
  const resetCodeBtn = document.getElementById('resetCodeBtn');
  const outputEl = document.getElementById('output');

  const showQuizBtn = document.getElementById('showQuizBtn');
  const quizArea = document.getElementById('quizArea');
  const submitQuizBtn = document.getElementById('submitQuizBtn');
  const markCompleteBtn = document.getElementById('markCompleteBtn');
  const stageScoreEl = document.getElementById('stageScore');

  // -------- STATE --------
  let currentUser = null;
  let currentStageIndex = 0; // 0-based
  const TOTAL_STAGES = 10;
  let progress = { stage_no: 0, percentage: 0 }; // stage_no = last completed stage (1-based)
  let stageResults = Array(TOTAL_STAGES).fill(null); // {score, passed, saved}
  let locked = false;

  // -------- COURSE CONTENT --------
  // For each stage: title, lesson (HTML string), starter code, quiz array
  const stages = [
    {
      title: 'Stage 1 — Introduction & Setup',
      lesson: `<p><strong>What is Python?</strong> Python is a friendly, high-level language excellent for scripting, calculations and building small programs quickly. This first stage shows how to print text, use variables and do simple math.</p>
        <p><strong>Why learn this?</strong> Engineers use Python to automate tasks, process data and prototype ideas fast.</p>
        <p><strong>Short manual-style steps:</strong></p>
        <ol>
          <li>Open the code editor on the right.</li>
          <li>Read the starter code and click <em>Run</em>.</li>
          <li>Observe output. Try changing a value and run again.</li>
        </ol>`,
      starter: `# Stage 1: Hello world & arithmetic\nname = "Student"\nprint("Hello,", name)\nprint("2 + 3 =", 2 + 3)\n# Try: change name or add more prints`,
      quiz: [
        { q: 'Which function prints output in Python?', a: ['echo()', 'print()', 'console.log()', 'output()'], correct:1 },
        { q: 'What type is "42" (with quotes)?', a: ['int', 'str', 'float', 'bool'], correct:1 },
        { q: 'What will print(2*3) output?', a: ['5','6','23','Error'], correct:1 },
        { q: 'Python source files usually use which extension?', a: ['.py', '.js', '.java', '.txt'], correct:0 },
        { q: 'Is Python statically typed?', a: ['True','False','Depends','Sometimes'], correct:1 }
      ]
    },
    {
      title: 'Stage 2 — Variables & Types',
      lesson: `<p><strong>Variables</strong> hold values. Types you will meet immediately: <code>int</code>, <code>float</code>, <code>str</code>, <code>bool</code>.</p>
        <p><strong>Short tips:</strong> variables are assigned with <code>=</code>. Use <code>type(x)</code> to see a variable's type.</p>
        <p>Example use-case: storing sensor readings, names, or flags.</p>`,
      starter: `# Stage 2: Variables & Types\nx = 10\ny = 2.5\nname = "MiniBotix"\nprint("x:", x, "type:", type(x))\nprint("y:", y, "type:", type(y))\nprint("name:", name, "type:", type(name))`,
      quiz: [
        { q: 'Which converts "3.14" to float?', a: ['int("3.14")','float("3.14")','str(3.14)','None'], correct:1 },
        { q: 'Which is boolean True in Python?', a: ['"True"','True','1','"1"'], correct:1 },
        { q: 'What is type("hello")?', a: ['int','str','list','bool'], correct:1 },
        { q: 'What does // do?', a: ['Float division','Modulus','Integer (floor) division','Power'], correct:2 },
        { q: 'Which is immutable?', a: ['list','dict','str','set'], correct:2 }
      ]
    },
    {
      title: 'Stage 3 — Control Flow (if / else)',
      lesson: `<p><strong>If statements</strong> let you run code conditionally. Use <code>if</code>, <code>elif</code>, and <code>else</code>. Indentation is the structure in Python—pay attention to spaces.</p>
        <p>Short example included below. Try changing conditions to see different outputs.</p>`,
      starter: `# Stage 3: If/else\nx = 7\nif x % 2 == 0:\n    print(x, "is even")\nelif x % 3 == 0:\n    print(x, "divisible by 3")\nelse:\n    print(x, "is odd and not divisible by 3")`,
      quiz: [
        { q: 'Which operator tests equality?', a: ['=','==','===',':='], correct:1 },
        { q: 'Keyword for alternative branch?', a: ['otherwise','elif','elseif','or'], correct:1 },
        { q: 'Does indentation matter in Python?', a: ['True','False','Only sometimes','No'], correct:0 },
        { q: 'For x=10 which prints: if x>5: print("A") elif x>8: print("B")', a: ['A','B','Both','Error'], correct:0 },
        { q: 'Valid condition syntax?', a: ['x = 5','x == 5','if x: 5','if x = 5:'], correct:1 }
      ]
    },
    {
      title: 'Stage 4 — Loops (for & while)',
      lesson: `<p><strong>Loops</strong> repeat tasks. Use <code>for</code> to iterate sequences and <code>while</code> to continue while a condition holds. Typical tasks: iterate sensor values or generate repeated logs.</p>`,
      starter: `# Stage 4: Loops\nfor i in range(5):\n    print("i =", i)\n\nn = 3\nwhile n>0:\n    print("tick", n)\n    n -= 1`,
      quiz: [
        { q: 'How to loop 0..4?', a: ['for i in 0..4','for i in range(5)','for (i=0;i<5;i++)','while i<5:'], correct:1 },
        { q: 'What does range(2,5) yield?', a: ['0,1,2,3,4','2,3,4','2,3,4,5','Error'], correct:1 },
        { q: 'Break exits the loop?', a: ['Yes','No','Only in while','Only in for'], correct:0 },
        { q: 'Continue skips current iteration', a: ['True','False','Maybe','Only in Python 3'], correct:0 },
        { q: 'While needs counter to avoid infinite loop?', a: ['Always','Never','Often yes','Not required'], correct:2 }
      ]
    },
    {
      title: 'Stage 5 — Functions',
      lesson: `<p><strong>Functions</strong> let you wrap behavior into reusable blocks. Use <code>def name(params):</code> and <code>return</code> to get results back.</p>
        <p>Good practice: small functions, meaningful names, one job per function.</p>`,
      starter: `# Stage 5: Functions\ndef add(a, b):\n    return a + b\n\nprint("add(3,4) =", add(3,4))`,
      quiz: [
        { q: 'How to define a function?', a: ['function x():','def x():','func x():','define x():'], correct:1 },
        { q: 'Keyword to return from function?', a: ['exit','return','yield','send'], correct:1 },
        { q: 'Are Python functions first-class?', a: ['Yes','No','Only in 3.8+','Only if decorated'], correct:0 },
        { q: 'Default parameters should be placed?', a: ['First','Middle','Last','Anywhere'], correct:2 },
        { q: 'Lambda creates anonymous function?', a: ['True','False','Only in 3.0','Only for IO'], correct:0 }
      ]
    },
    {
      title: 'Stage 6 — Lists & Dictionaries',
      lesson: `<p><strong>Lists</strong> are ordered collections. <strong>Dicts</strong> map keys to values. They are essential for storing tabular or structured data.</p>
        <p>Common actions: index, append, pop, keys(), values().</p>`,
      starter: `# Stage 6: Lists & Dicts\nfruits = ['apple','banana']\nfruits.append('cherry')\nprint(fruits)\n\nperson = {'name': 'A', 'age': 20}\nprint(person['name'])`,
      quiz: [
        { q: "Access first element of list 'a'?", a: ['a(0)','a[0]','a.0','a.first()'], correct:1 },
        { q: 'Which creates a dict?', a: ["{'k':1}", "['k',1]", "('k',1)", "{'k'}"], correct:0 },
        { q: 'append adds to end of list?', a: ['True','False','Maybe','Only for strings'], correct:0 },
        { q: 'keys() on dict returns?', a: ['list','view','string','int'], correct:1 },
        { q: 'pop() removes and returns?', a: ['True','False','It raises','No'], correct:0 }
      ]
    },
    {
      title: 'Stage 7 — File I/O & Exceptions',
      lesson: `<p>Files: use <code>open(...)</code>. Prefer the <code>with</code> pattern to auto-close files. Handle errors with <code>try/except</code>.</p>
        <p>We will not write files in the browser, but you should know how to in real projects.</p>`,
      starter: `# Stage 7: File I/O (demo)\nprint("In a desktop Python you would use open('file.txt','w') to write.")\n# Example:\n# with open('out.txt', 'w') as f:\n#     f.write('hello')`,
      quiz: [
        { q: 'Open file for reading?', a: ["open('f','r')","open('f','w')","open('f','rw')","open('f')"], correct:0 },
        { q: 'Context manager auto-closes file?', a: ['True','False','Only in 3.10','Only with try'], correct:0 },
        { q: 'Which catches exceptions?', a: ['try/except','if/error','throw/catch','try/catch'], correct:0 },
        { q: 'Finally block runs when?', a: ['Always after try','Only on exceptions','Never','Before try'], correct:0 },
        { q: 'open(..., "a") mode means?', a: ['append','write','read','error'], correct:0 }
      ]
    },
    {
      title: 'Stage 8 — Modules & Libraries',
      lesson: `<p>Use modules to reuse code. Loading libraries: <code>import math</code>, <code>import random</code> etc. When you need external libraries (numpy, pandas), install them in your environment.</p>`,
      starter: `# Stage 8: Modules\nimport math\nprint('sqrt(25)=', math.sqrt(25))\nimport random\nprint('dice:', random.randint(1,6))`,
      quiz: [
        { q: 'Import sqrt only from math?', a: ['from math import sqrt','import math.sqrt','import sqrt from math','include math.sqrt'], correct:0 },
        { q: 'json.dumps creates string?', a: ['True','False','Depends','Only with indent'], correct:0 },
        { q: 'Library for numerical arrays?', a: ['numpy','pandas','django','flask'], correct:0 },
        { q: 'random.randint(1,3) includes 3?', a: ['Yes','No','Only sometimes','Depends'], correct:0 },
        { q: 'Create modules by saving .py files?', a: ['True','False','Only in packages','Only with __init__'], correct:0 }
      ]
    },
    {
      title: 'Stage 9 — Simple Data Handling',
      lesson: `<p>Combine lists, dicts, loops, and comprehensions to filter and transform data. This is useful when you need to process sensor logs or CSV rows.</p>`,
      starter: `# Stage 9: Data handling\ndata = [1,2,3,4,5]\nsquares = [x*x for x in data]\nprint('squares:', squares)\n# filter even\nevens = [x for x in data if x%2==0]\nprint('evens:', evens)`,
      quiz: [
        { q: 'List comprehension example?', a: ['[x for x in list]','(x for x in list)','{x for x in list}','<x for x>'], correct:0 },
        { q: 'map() returns?', a: ['map object','list','string','int'], correct:0 },
        { q: 'filter() selects items?', a: ['True','False','Only for sets','No'], correct:0 },
        { q: 'reduce() reduces sequence to value?', a: ['True','False','Only for numbers','No'], correct:0 },
        { q: 'Which creates tuple?', a: ['(1,2)','[1,2]','{1,2}','<1,2>'], correct:0 }
      ]
    },
    {
      title: 'Stage 10 — Mini Project & Wrap-up',
      lesson: `<p>Combine everything: think of a small task — parse a list, filter values, compute a metric and print result. This final stage confirms you can build a small useful script.</p>
        <p>When you complete the quiz and mark as complete we will send your final progress to the sheet and lock the course for your account.</p>`,
      starter: `# Stage 10: Mini project\nnums = [1,2,3,4,5,6,7,8,9,10]\nevens = [n for n in nums if n%2==0]\nprint('Even numbers:', evens)\nprint('Count:', len(evens))`,
      quiz: [
        { q: 'Project stage checks integration of topics', a: ['True','False','Only coding','Only quiz'], correct:0 },
        { q: 'List comprehension can replace loops', a: ['Yes','No','Only with range','Only in Python 2'], correct:0 },
        { q: 'Functions help reuse code', a: ['True','False','They slow code','Only for OOP'], correct:0 },
        { q: 'Modules help organize code', a: ['True','False','Only for packages','No'], correct:0 },
        { q: 'Final step should be', a: ['Stop','Submit progress','Delete files','Rename project'], correct:1 }
      ]
    }
  ];

  // -------- UTILS --------
  function showToast(msg, err=false, duration=3000){
    const div = document.createElement('div');
    div.className = 'mini-toast';
    div.textContent = msg;
    div.style.background = err ? '#ff6b6b' : 'linear-gradient(90deg,#00c6ff,#0066ff)';
    div.style.color = err ? '#fff' : '#021';
    div.style.padding = '10px 14px';
    div.style.borderRadius = '8px';
    div.style.fontWeight = 700;
    div.style.zIndex = 99999;
    document.body.appendChild(div);
    setTimeout(()=>{ div.style.transition='all .3s'; div.style.opacity='0'; div.style.transform += ' translateY(8px)'; }, duration-250);
    setTimeout(()=>div.remove(), duration);
  }
  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function nowIso(){ return (new Date()).toISOString(); }

  // -------- RENDER STAGES LIST --------
  function renderStagesList(){
    stagesListEl.innerHTML = '';
    for(let i=0;i<TOTAL_STAGES;i++){
      const pill = document.createElement('div');
      pill.className = 'stage-pill';
      if(i > currentStageIndex) pill.classList.add('locked');
      const short = stages[i].title.split('—')[1] ? stages[i].title.split('—')[1].trim() : stages[i].title;
      pill.innerHTML = `Stage ${i+1}: ${escapeHtml(short)}`;
      pill.dataset.index = i;
      if(i <= currentStageIndex){
        pill.addEventListener('click', ()=> loadStage(i));
      }
      stagesListEl.appendChild(pill);
    }
  }

  // -------- APPSCRIPT INTERACTIONS (GET / POST) --------
  // GET: APP_SCRIPT_URL?email=someone@example.com
  async function fetchProgressFromBackend(email){
    try{
      if(!email) return null;
      const url = APP_SCRIPT_URL + '?email=' + encodeURIComponent(email) + '&course_name=' + encodeURIComponent(COURSE_NAME);
      const res = await fetch(url, { method: 'GET', mode: 'cors' });
      if(!res.ok) return null;
      const json = await res.json();
      // Expecting { status: 'success', rows: [...] } or { rows: [...] }
      const rows = json.rows || json.data || json.progress || [];
      if(!Array.isArray(rows) || rows.length === 0) return null;
      // pick latest by timestamp or last row
      rows.sort((a,b)=>{
        const ta = new Date(a.timestamp || a.Timestamp || a.time || 0).getTime();
        const tb = new Date(b.timestamp || b.Timestamp || b.time || 0).getTime();
        return tb - ta;
      });
      return rows[0];
    }catch(e){
      console.warn('fetchProgress error', e);
      return null;
    }
  }

  // POST: send payload {name,email,course_name,stage_no,percentage,timestamp}
  async function postProgress(payload){
    try{
      const res = await fetch(APP_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        mode: 'cors'
      });
      const bodyText = await res.text();
      let body = null;
      try{ body = JSON.parse(bodyText); }catch(e){ body = bodyText; }
      return { ok: res.ok, status: res.status, body };
    }catch(e){
      console.error('postProgress error', e);
      return { ok:false, error:e };
    }
  }

  // -------- AUTH UI & FLOW --------
  function updateSignUi(){
    if(currentUser){
      userNameEl.textContent = currentUser.displayName ? currentUser.displayName.split(' ')[0] : (currentUser.email || 'User');
      signBtn.textContent = 'Sign Out';
      signBtn.onclick = async ()=> {
        try{ await signOut(auth); showToast('Signed out'); }
        catch(e){ console.warn(e); showToast('Sign-out failed', true); }
      };
    } else {
      userNameEl.textContent = 'Guest';
      signBtn.textContent = 'Sign In';
      signBtn.onclick = showSignPopup;
    }
  }

  async function showSignPopup(){
    const provider = new GoogleAuthProvider();
    try{
      await signInWithPopup(auth, provider);
      showToast('Signed in');
    }catch(e){
      console.error('signin failed', e);
      showToast('Sign-in failed', true);
    }
  }

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    updateSignUi();
    if(user){
      // fetch server progress and resume
      const row = await fetchProgressFromBackend(user.email);
      if(row){
        // try several possible field names
        const sn = parseInt(row.stage_no || row['stage_no'] || row.stage || row.Stage || row.stageNo || row['Stage No'] || 0) || 0;
        const pct = Number(row.percentage || row['percentage'] || row.Percentage || 0) || 0;
        if(sn > 0){
          progress.stage_no = sn;
          progress.percentage = pct;
          // set stage index to the stage they should be allowed to open
          // if stage_no is N, last completed stage is N, next unlock is N+1 (index N)
          currentStageIndex = Math.min(TOTAL_STAGES - 1, Math.max(0, sn));
        }
        if(progress.stage_no >= TOTAL_STAGES && progress.percentage >= 100){
          locked = true;
          showToast('Course already completed for this account', false);
        }
      }
      renderStagesList();
      updateProgressUI();
      // if they already completed something, open the last unlocked
      if(progress.stage_no > 0){
        const openIndex = Math.max(0, progress.stage_no - 1);
        loadStage(openIndex);
      }
    } else {
      // not signed in - reset to default
      renderStagesList();
      updateProgressUI();
    }
  });

  // -------- STAGE / QUIZ / RUNNER LOGIC --------
  function updateProgressUI(){
    const displayStage = Math.min(currentStageIndex + 1, TOTAL_STAGES);
    progressTextEl.textContent = `Stage ${displayStage} / ${TOTAL_STAGES}`;
  }

  function loadStage(index){
    if(locked){ showToast('Course completed — cannot re-take', true); return; }
    if(index > currentStageIndex){ showToast('Stage locked. Complete previous stages first.', true); return; }
    currentStageIndex = index;
    const st = stages[index];
    lessonTitleEl.innerHTML = `${escapeHtml(st.title)}`;
    lessonContentEl.innerHTML = st.lesson;
    editorEl.value = st.starter;
    outputEl.textContent = '';
    stageStatusEl.textContent = (stageResults[index] && stageResults[index].passed) ? 'Passed' : 'In progress';
    quizArea.style.display = 'none';
    document.getElementById('stageScore').textContent = stageResults[index] && stageResults[index].score !== undefined ? stageResults[index].score + '%' : '—';
    renderStagesList();
    updateProgressUI();
    // hide quiz area, user clicks Show Quiz to start
  }

  function renderQuiz(index){
    const st = stages[index];
    quizArea.innerHTML = '';
    quizArea.style.display = 'block';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.style.marginBottom='8px'; title.textContent = 'Quiz (5 questions)';
    quizArea.appendChild(title);

    const qWrap = document.createElement('div');
    st._userAnswers = st._userAnswers || {};
    st.quiz.forEach((q,i)=>{
      const qbox = document.createElement('div');
      qbox.className = 'q';
      const qtitle = document.createElement('div');
      qtitle.style.fontWeight = 600;
      qtitle.textContent = `Q${i+1}. ${q.q}`;
      qbox.appendChild(qtitle);

      const ans = document.createElement('div'); ans.className = 'answers';
      q.a.forEach((opt,j)=>{
        const b = document.createElement('button');
        b.className = 'answer-btn';
        b.type = 'button';
        b.innerHTML = escapeHtml(opt);
        b.style.textAlign = 'left';
        b.onclick = ()=>{
          // single-select per question — visually mark
          Array.from(ans.children).forEach(bb=>{ bb.style.background='transparent'; bb.style.borderColor='rgba(255,255,255,0.04)'; });
          b.style.background = 'rgba(0, 212, 255, 0.12)';
          b.style.borderColor = 'rgba(0,212,255,0.25)';
          st._userAnswers[i] = j;
        };
        ans.appendChild(b);
      });
      qbox.appendChild(ans);
      qWrap.appendChild(qbox);
    });
    quizArea.appendChild(qWrap);
  }

  // -------- SKULPT RUNNER (in-browser python) --------
  function skulptOut(text){
    // append text to output
    outputEl.textContent += text;
  }
  function skulptBuiltinRead(x){
    if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
      throw "File not found: '" + x + "'";
    return Sk.builtinFiles["files"][x];
  }

  async function runCode(){
    outputEl.textContent = '';
    const prog = editorEl.value || '';
    Sk.configure({ output: skulptOut, read: skulptBuiltinRead });
    try{
      await Sk.misceval.asyncToPromise(()=>Sk.importMainWithBody("<stdin>", false, prog, true));
    }catch(e){
      outputEl.textContent += '\nError: ' + (e.toString ? e.toString() : e);
    }
  }

  runBtn.addEventListener('click', ()=> {
    // small UX: show quick toast for running
    showToast('Running code...');
    runCode();
  });

  resetCodeBtn.addEventListener('click', ()=> {
    const st = stages[currentStageIndex];
    editorEl.value = st.starter;
    outputEl.textContent = '';
  });

  showQuizBtn.addEventListener('click', ()=> {
    renderQuiz(currentStageIndex);
    // scroll to quiz
    quizArea.scrollIntoView({behavior:'smooth'});
  });

  // submit quiz
  submitQuizBtn.addEventListener('click', ()=> {
    const st = stages[currentStageIndex];
    const answers = st._userAnswers || {};
    let correct = 0;
    for(let i=0;i<st.quiz.length;i++){
      if(answers[i] !== undefined && Number(answers[i]) === Number(st.quiz[i].correct)) correct++;
    }
    const pct = Math.round((correct / st.quiz.length) * 100);
    stageResults[currentStageIndex] = { score: pct, passed: pct >= PASS_PERCENT, saved: false };
    stageScoreEl.textContent = `${pct}% (${correct}/${st.quiz.length})`;
    stageStatusEl.textContent = stageResults[currentStageIndex].passed ? 'Passed' : 'Failed';
    showToast(`Quiz scored ${pct}%`);
  });

  // mark complete and save
  markCompleteBtn.addEventListener('click', async ()=> {
    const res = stageResults[currentStageIndex];
    if(!res){ showToast('Submit the quiz first', true); return; }
    if(!res.passed){ showToast('Score below passing threshold. Retake quiz.', true); return; }
    // compute cumulative percentage (average of completed stages)
    let sum=0,count=0;
    for(let i=0;i<=currentStageIndex;i++){
      if(stageResults[i] && typeof stageResults[i].score === 'number'){ sum += stageResults[i].score; count++; }
    }
    const cumulativePct = count ? Math.round(sum / count) : 0;
    const completedStageNo = currentStageIndex + 1; // 1-based
    progress.stage_no = Math.max(progress.stage_no, completedStageNo);
    progress.percentage = cumulativePct;

    if(!currentUser){
      showToast('Sign in to save progress', true);
      return;
    }

    const payload = {
      name: currentUser.displayName || currentUser.email.split('@')[0] || '',
      email: currentUser.email || '',
      course_name: COURSE_NAME,
      stage_no: progress.stage_no,
      percentage: progress.percentage,
      timestamp: nowIso()
    };

    const posted = await postProgress(payload);
    if(posted.ok){
      showToast('Progress saved to Google Sheet');
      stageResults[currentStageIndex].saved = true;

      // update Firestore optional user meta
      try{
        await setDoc(doc(db, 'users', currentUser.uid), { lastCourse: COURSE_NAME, lastCourseAt: serverTimestamp(), lastStage: progress.stage_no }, { merge: true });
      }catch(e){ /* ignore */ }

      // unlock next stage or finish course
      if(currentStageIndex < TOTAL_STAGES - 1){
        currentStageIndex++;
      } else {
        // final completion - send final confirmation row
        progress.stage_no = TOTAL_STAGES;
        progress.percentage = Math.round((stageResults.reduce((s,r)=> s + (r && r.score||0), 0) / TOTAL_STAGES) || progress.percentage);
        await postProgress({ name: currentUser.displayName||'', email: currentUser.email, course_name: COURSE_NAME, stage_no: progress.stage_no, percentage: progress.percentage, timestamp: nowIso() });
        showToast('Course completed — congratulations 🎉');
        locked = true;
      }
      renderStagesList();
      updateProgressUI();
      loadStage(Math.min(currentStageIndex, TOTAL_STAGES - 1));
    } else {
      console.warn('postProgress failed', posted);
      showToast('Failed to save progress to backend', true);
    }
  });

  // Start / Resume button
  startBtn.addEventListener('click', async ()=> {
    if(!currentUser){
      showToast('Please sign in to save & resume progress', false);
      await showSignPopup();
      return;
    }
    // try to fetch progress row
    const row = await fetchProgressFromBackend(currentUser.email);
    if(row){
      const sn = parseInt(row.stage_no || row['stage_no'] || row.stage || 0) || 0;
      const pct = Number(row.percentage || row['percentage'] || 0) || 0;
      progress.stage_no = sn;
      progress.percentage = pct;
      // if last completed stage is N, next unlock is N+1 (index N)
      currentStageIndex = Math.min(TOTAL_STAGES - 1, Math.max(0, sn));
    } else {
      currentStageIndex = 0;
    }
    renderStagesList();
    updateProgressUI();
    loadStage(currentStageIndex);
  });

  overviewBtn.addEventListener('click', ()=> {
    const list = stages.map((s,i)=>`${i+1}. ${s.title.replace('Stage ' + (i+1) + ' — ','')}`).join('\n');
    alert('Course overview:\n\n' + list);
  });

  // Initialize
  for(let i=0;i<TOTAL_STAGES;i++) stageResults[i] = null;
  renderStagesList();
  updateProgressUI();
  // populate editor with first starter by default
  editorEl.value = stages[0].starter;

  // update sign UI
  updateSignUi();

  // prevent accidental unload (optional)
  window.addEventListener('beforeunload', (e)=>{
    // if user has unsaved quiz results we could prompt; left empty for smoother UX
  });

  // expose for debugging (optional)
  window._stages = stages;
  window._stageResults = stageResults;

</script>
</body>
</html>
