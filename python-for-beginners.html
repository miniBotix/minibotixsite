<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniBotix ¬∑ Python Beginner ‚Äî Course</title>
<link rel="icon" href="file.svg" type="image/svg+xml">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071126;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --accent1: #007bff;
    --accent2: #00d4ff;
    --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;color:#fff;background:var(--bg);-webkit-font-smoothing:antialiased}
  a{color:inherit;text-decoration:none}

  /* header */
  header.nav{position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 22px;background:rgba(0,0,0,0.5);backdrop-filter:blur(6px);z-index:90}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
  .brand img{height:36px;width:36px;border-radius:6px}
  .back-btn{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.9);cursor:pointer}
  .top-actions{display:flex;gap:12px;align-items:center}

  /* hero */
  .hero{padding:110px 22px 28px 22px}
  .hero-card{max-width:1100px;margin:0 auto;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:24px;border-radius:14px;box-shadow:0 30px 60px rgba(3,7,20,0.6)}
  .eyebrow{display:inline-block;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;margin-bottom:12px;color:#aee9ff;font-weight:600}
  .hero h1{font-size:28px;margin:6px 0 8px;line-height:1.03}
  .hero p{color:rgba(255,255,255,0.85);margin-bottom:12px;max-width:900px}

  .progress-pill{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
  .btn-primary{background:var(--accent-grad);padding:10px 16px;border-radius:999px;border:none;color:#fff;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,0.45)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}

  /* content area */
  .section{padding:28px 22px 90px}
  .container{max-width:1100px;margin:0 auto}
  h2{font-size:22px;margin-bottom:10px}
  .lead{color:rgba(255,255,255,0.8);margin-bottom:14px}

  /* stage panel */
  .stage-panel{display:grid;grid-template-columns:1fr 520px;gap:18px;align-items:start}
  .lesson-card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .lesson-title{font-size:20px;font-weight:700;margin-bottom:8px}
  .lesson-content{color:rgba(255,255,255,0.9);line-height:1.6}
  .lesson-content pre{background:#041018;padding:12px;border-radius:8px;color:#cde;overflow:auto}

  /* right column: runner & quiz */
  .runner-card{background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
  .editor{width:100%;height:300px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#06101a;padding:12px;color:#fff;font-family:monospace;resize:vertical;overflow:auto}
  .outbox{min-height:120px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#050816;padding:10px;color:#d6f7ff;font-family:monospace;font-size:13px;white-space:pre-wrap;overflow:auto}

  .quiz{margin-top:12px}
  .q{margin-bottom:8px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:rgba(255,255,255,0.01)}
  .answers{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .answer-btn{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;cursor:pointer;text-align:left}

  .stage-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .muted{color:rgba(255,255,255,0.65);font-size:13px}

  /* stage list */
  .stages-list{display:flex;gap:8px;overflow:auto;padding:8px;margin-bottom:14px}
  .stage-pill{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;white-space:nowrap}
  .stage-pill.locked{opacity:0.35;cursor:not-allowed}
  .stage-pill.active{background:linear-gradient(90deg,#00d4ff,#007bff);color:#021;font-weight:700}

  /* mini compiler modal */
  .modal { position: fixed; right: 22px; bottom: 22px; width: 520px; max-width: calc(100% - 44px); background: #071426; border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 10px 30px rgba(0,0,0,0.6); z-index:999; display:none; }
  .modal .title { font-weight:700; margin-bottom:8px; display:flex;justify-content:space-between; align-items:center; gap:8px}
  .modal textarea { height:160px; width:100%; border-radius:8px; padding:10px; background:#06101a;color:#fff;border:1px solid rgba(255,255,255,0.03); font-family:monospace}
  .modal .output { margin-top:8px; height:140px; overflow:auto; background:#050816; border-radius:8px; padding:10px; font-family:monospace; color:#cde; white-space:pre-wrap }

  @media (max-width:980px){
    .stage-panel{grid-template-columns:1fr}
    .runner-card{order:2}
    .modal{ right: 10px; left:10px; width: auto; bottom: 10px; }
  }

  /* small toast */
  .mini-toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 22px; padding: 10px 14px; border-radius: 8px; z-index: 9999; font-weight:600 }
</style>
</head>
<body>

<!-- HEADER -->
<header class="nav">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="back-btn" onclick="location.href='courses.html'">‚Üê Back</div>
    <div class="brand">
      <img src="file.svg" alt="MiniBotix">
      <div style="line-height:1">
        <div style="font-weight:700">MiniBotix</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.6)">Python ¬∑ Beginner</div>
      </div>
    </div>
  </div>

  <div class="top-actions">
    <div id="progressPill" class="progress-pill">Progress: <span id="progressText">Stage 0 / 10</span></div>
    <div style="display:flex;align-items:center;gap:10px">
      <div id="userName" style="font-weight:600;color:rgba(255,255,255,0.9)">Guest</div>
      <button id="signBtn" class="btn-ghost">Sign In</button>
      <button id="openCompilerTop" class="btn-ghost">Open Compiler</button>
    </div>
  </div>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-card container">
    <div class="eyebrow">MiniBotix ¬∑ Courses ¬∑ Python</div>
    <h1>Python for Engineers ‚Äî Beginner Track</h1>
    <p class="lead">Ten-stage interactive course. Each stage has a clear lesson, runnable examples, and a 5-question quiz. Run code with the built-in Python (Pyodide). Pass (‚â•60%) to unlock the next stage. Progress is saved to Google Sheets so you can resume later.</p>
    <div style="display:flex;gap:12px;align-items:center">
      <button class="btn-primary" id="startBtn">Start / Resume</button>
      <button class="btn-ghost" id="overviewBtn">Course Overview</button>
    </div>
  </div>
</section>

<!-- MAIN -->
<section class="section">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2>Course Stages</h2>
      <div class="muted">Complete stages sequentially. Scores are stored against your account.</div>
    </div>

    <div class="stages-list" id="stagesList"></div>

    <div id="mainStageArea" class="stage-panel">
      <div class="lesson-card">
        <div class="lesson-title" id="lessonTitle">Welcome</div>
        <div class="lesson-content" id="lessonContent">
          <p>Press "Start" to begin. Sign in to save progress and resume. Each stage contains: a lesson, example code you can run, a code exercise, and a short 5-question multiple-choice quiz. Achieve ‚â• 60% to pass a stage and unlock the next one.</p>
        </div>

        <div style="margin-top:12px">
          <strong>Stage status:</strong> <span id="stageStatus" class="muted">Not started</span>
        </div>
      </div>

      <div class="runner-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:700">Code Runner</div>
          <div style="display:flex;gap:8px">
            <button id="runBtn" class="btn-ghost">Run</button>
            <button id="resetCodeBtn" class="btn-ghost">Reset</button>
            <button id="showQuizBtn" class="btn-ghost">Show Quiz</button>
          </div>
        </div>

        <textarea id="editor" class="editor" spellcheck="false" aria-label="Python code editor"></textarea>
        <div style="margin-top:8px;font-weight:700">Output</div>
        <div id="output" class="outbox" role="status" aria-live="polite">Program output will appear here</div>

        <div class="quiz" id="quizArea" style="display:none"></div>

        <div class="stage-footer">
          <div>
            <button id="submitQuizBtn" class="btn-primary">Submit Quiz</button>
            <button id="markCompleteBtn" class="btn-ghost">Mark Complete (if quiz passed)</button>
          </div>
          <div class="muted">Stage Score: <span id="stageScore">‚Äî</span></div>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- Mini Compiler Modal (common) -->
<div id="miniCompiler" class="modal" aria-hidden="true">
  <div class="title">
    <div>Mini Python Compiler</div>
    <div style="display:flex;gap:8px">
      <button id="miniRun" class="btn-primary">Run</button>
      <button id="miniClose" class="btn-ghost">Close</button>
    </div>
  </div>
  <textarea id="miniEditor">print("Hello from mini compiler")</textarea>
  <div id="miniOutput" class="output">Output</div>
</div>

<!-- Footer -->
<footer style="padding-bottom:40px">
  <div class="container" style="text-align:center">
    <div style="margin-bottom:8px">MiniBotix ¬∑ Learn ¬∑ Build ¬∑ Innovate</div>
    <small>¬© 2025 MiniBotix</small>
  </div>
</footer>

<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

<!-- Firebase (modular) -->
<script type="module">
  // ----------------- CONFIG -----------------
  const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxApgefcqGK1KLybeyHiVlnbNKDM9oXL0d7-c_MyIsMiv3qvlj6-Og1RTsOU5KrSFGl/exec';
  const COURSE_NAME = 'Python Beginner';
  const PASS_PERCENT = 60; // pass threshold
  const firebaseConfig = {
    apiKey: "AIzaSyDWmliHHP7UR1pmM6CNjY6o_NvF-hYJWpY",
    authDomain: "minibotix-a1b9a.firebaseapp.com",
    projectId: "minibotix-a1b9a",
    storageBucket: "minibotix-a1b9a.firebasestorage.app",
    messagingSenderId: "771169717230",
    appId: "1:771169717230:web:44848d73e548d0e0f8dcff",
    measurementId: "G-JQKFSBN4WP"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ----------------- UI REFS -----------------
  const signBtn = document.getElementById('signBtn');
  const userNameEl = document.getElementById('userName');
  const startBtn = document.getElementById('startBtn');
  const overviewBtn = document.getElementById('overviewBtn');
  const stagesListEl = document.getElementById('stagesList');
  const lessonTitleEl = document.getElementById('lessonTitle');
  const lessonContentEl = document.getElementById('lessonContent');
  const stageStatusEl = document.getElementById('stageStatus');
  const progressTextEl = document.getElementById('progressText');
  const editorEl = document.getElementById('editor');
  const runBtn = document.getElementById('runBtn');
  const resetCodeBtn = document.getElementById('resetCodeBtn');
  const outputEl = document.getElementById('output');
  const showQuizBtn = document.getElementById('showQuizBtn');
  const quizArea = document.getElementById('quizArea');
  const submitQuizBtn = document.getElementById('submitQuizBtn');
  const markCompleteBtn = document.getElementById('markCompleteBtn');
  const stageScoreEl = document.getElementById('stageScore');
  const openCompilerTop = document.getElementById('openCompilerTop');

  const miniModal = document.getElementById('miniCompiler');
  const miniEditor = document.getElementById('miniEditor');
  const miniOutput = document.getElementById('miniOutput');
  const miniRun = document.getElementById('miniRun');
  const miniClose = document.getElementById('miniClose');

  // ----------------- STATE -----------------
  let currentUser = null;
  let currentStageIndex = 0; // 0-based index for UI (which stage user is viewing)
  const TOTAL_STAGES = 10;
  let progress = { stage_no: 0, percentage: 0 }; // stage_no is last completed stage (1-based)
  let stageResults = Array(TOTAL_STAGES).fill(null); // store {score, passed, saved}
  let locked = false;
  let pyodide = null;
  let pyodideReady = false;

  // ----------------- COURSE DATA (embedded JSON - detailed but concise) -----------------
  // You can replace content below with any updated JSON structure later.
  const courseData = [
    {
      "title": "Stage 1 ‚Äî Introduction & Setup",
      "topicShort": "Intro & Hello World",
      "lesson": "<p>Python is a simple language for scripting, automation and quick prototypes. In this stage you'll run your first program, learn how printing works, and try basic arithmetic.</p><pre>print('Hello, world!')\nprint('2 + 2 =', 2+2)</pre><p>Try changing text or numbers and run again.</p>",
      "starter": "# Stage 1: Hello & arithmetic\nname = 'Student'\nprint('Hello,', name)\nprint('2 + 3 =', 2 + 3)\n# Try changing name or adding prints",
      "quiz": [
        { "q": "Which function prints output in Python?", "options": ["echo()", "print()", "console.log()", "output()"], "correct": 1 },
        { "q": "What type is '42' (with quotes)?", "options": ["int", "str", "float", "bool"], "correct": 1 },
        { "q": "What will print(2*3) output?", "options": ["5", "6", "23", "Error"], "correct": 1 },
        { "q": "Python files typically end with?", "options": [".py", ".js", ".java", ".txt"], "correct": 0 },
        { "q": "Is Python statically typed?", "options": ["True", "False", "Depends", "Sometimes"], "correct": 1 }
      ]
    },
    {
      "title": "Stage 2 ‚Äî Variables & Types",
      "topicShort": "Variables & Types",
      "lesson": "<p>Variables store values like numbers or text. Use <code>=</code> to assign. Common types: <code>int</code>, <code>float</code>, <code>str</code>, <code>bool</code>.</p><pre>x = 10\ny = 2.5\nname = 'MiniBotix'\nprint(x, y, name)</pre>",
      "starter": "# Stage 2: Variables & Types\nx = 10\ny = 2.5\nname = 'MiniBotix'\nprint('x:', x, 'type:', type(x))\nprint('name:', name, 'type:', type(name))",
      "quiz": [
        { "q": "Which converts '3.14' to a float?", "options": ["int('3.14')", "float('3.14')", "str(3.14)", "None"], "correct": 1 },
        { "q": "Which is boolean True in Python?", "options": ["'True'", "True", "1", "'1'"], "correct": 1 },
        { "q": "type('hello') returns?", "options": ["int", "str", "list", "bool"], "correct": 1 },
        { "q": "What does // do?", "options": ["Float division", "Modulus", "Integer floor division", "Power"], "correct": 2 },
        { "q": "Which is immutable?", "options": ["list", "dict", "str", "set"], "correct": 2 }
      ]
    },
    {
      "title": "Stage 3 ‚Äî Control Flow (if / else)",
      "topicShort": "If / Else",
      "lesson": "<p>If statements let you branch logic. Use <code>if</code>, <code>elif</code>, <code>else</code>. Indentation is meaningful in Python.</p><pre>x = 7\nif x % 2 == 0:\n    print('even')\nelse:\n    print('odd')</pre>",
      "starter": "# Stage 3: If/else\nx = 7\nif x % 2 == 0:\n    print(x, 'is even')\nelif x % 3 == 0:\n    print(x, 'divisible by 3')\nelse:\n    print(x, 'is odd and not divisible by 3')",
      "quiz": [
        { "q": "Which compares equality?", "options": ["=", "==", "===", ":="], "correct": 1 },
        { "q": "Keyword for other branch?", "options": ["otherwise", "elif", "elseif", "or"], "correct": 1 },
        { "q": "Does indentation matter?", "options": ["True", "False", "Only sometimes", "No"], "correct": 0 },
        { "q": "Which is valid condition?", "options": ["x = 5", "x == 5", "if x: 5", "if x = 5:"], "correct": 1 },
        { "q": "elif runs when?", "options": ["First branch false", "Always", "Only on exception", "Never"], "correct": 0 }
      ]
    },
    {
      "title": "Stage 4 ‚Äî Loops (for & while)",
      "topicShort": "Loops",
      "lesson": "<p>Loops repeat work. <code>for</code> iterates sequences. <code>while</code> runs while a condition holds.</p><pre>for i in range(5):\n    print(i)\n\nn = 3\nwhile n>0:\n    print('tick', n)\n    n -= 1</pre>",
      "starter": "# Stage 4: Loops\nfor i in range(5):\n    print('i =', i)\n\nn = 3\nwhile n>0:\n    print('tick', n)\n    n -= 1",
      "quiz": [
        { "q": "How to loop 0..4?", "options": ["for i in 0..4", "for i in range(5)", "for (i=0;i<5;i++)", "while i<5:"], "correct": 1 },
        { "q": "range(2,5) yields?", "options": ["0,1,2,3,4", "2,3,4", "2,3,4,5", "Error"], "correct": 1 },
        { "q": "Break exits loop immediately?", "options": ["Yes", "No", "Only in while", "Only in for"], "correct": 0 },
        { "q": "Continue skips to next iteration", "options": ["True", "False", "Maybe", "Only in Python 3"], "correct": 0 },
        { "q": "While needs a counter to avoid infinite loop?", "options": ["Always", "Never", "Often yes", "Not required"], "correct": 2 }
      ]
    },
    {
      "title": "Stage 5 ‚Äî Functions",
      "topicShort": "Functions",
      "lesson": "<p>Functions encapsulate logic. Use <code>def</code> and <code>return</code>. Keep functions short and focused.</p><pre>def add(a,b):\n    return a + b\nprint(add(3,4))</pre>",
      "starter": "# Stage 5: Functions\ndef add(a,b):\n    return a + b\n\nprint('add(3,4) =', add(3,4))",
      "quiz": [
        { "q": "Define a function with?", "options": ["function x():", "def x():", "func x():", "define x():"], "correct": 1 },
        { "q": "Return a value using?", "options": ["exit", "return", "yield", "send"], "correct": 1 },
        { "q": "Are functions first-class?", "options": ["Yes", "No", "Only in 3.8+", "Only if decorated"], "correct": 0 },
        { "q": "Default params placed where?", "options": ["First", "Middle", "Last", "Anywhere"], "correct": 2 },
        { "q": "Lambda creates anonymous function?", "options": ["True", "False", "Only in 3.0", "Only for IO"], "correct": 0 }
      ]
    },
    {
      "title": "Stage 6 ‚Äî Lists & Dictionaries",
      "topicShort": "Lists & Dicts",
      "lesson": "<p>Lists are ordered; dicts map keys to values. Use list methods and dict lookups.</p><pre>fruits = ['apple','banana']\nfruits.append('cherry')\nprint(fruits)\n\nperson = {'name':'A','age':20}\nprint(person['name'])</pre>",
      "starter": "# Stage 6: Lists & Dicts\nfruits = ['apple','banana']\nfruits.append('cherry')\nprint('fruits =', fruits)\n\nperson = {'name':'A','age':20}\nprint('name =', person['name'])",
      "quiz": [
        { "q": "Access first element of list 'a'?", "options": ["a(0)","a[0]","a.0","a.first()"], "correct": 1 },
        { "q": "Which creates a dict?", "options": ["{'k':1}", "['k',1]", "('k',1)", "{'k'}"], "correct": 0 },
        { "q": "append adds to end?", "options": ["True","False","Maybe","Only for strings"], "correct": 0 },
        { "q": "keys() returns?", "options": ["list","view","string","int"], "correct": 1 },
        { "q": "pop removes and returns?", "options": ["True","False","It raises","No"], "correct": 0 }
      ]
    },
    {
      "title": "Stage 7 ‚Äî File I/O & Exceptions",
      "topicShort": "File I/O & Errors",
      "lesson": "<p>Use <code>open()</code> and <code>with</code> to handle files. Use <code>try/except</code> to catch errors.</p><pre># Desktop example:\n# with open('out.txt','w') as f:\n#     f.write('hello')\nprint('In browser we show pattern but not write files')</pre>",
      "starter": "# Stage 7: File I/O\nprint('We will not write files in browser')\n# Example for desktop shown above",
      "quiz": [
        { "q": "Open file for reading?", "options": ["open('f','r')","open('f','w')","open('f','rw')","open('f')"], "correct": 0 },
        { "q": "Context manager auto-closes file?", "options": ["True","False","Only in 3.10","Only with try"], "correct": 0 },
        { "q": "Which catches exceptions?", "options": ["try/except","if/error","throw/catch","try/catch"], "correct": 0 },
        { "q": "Finally runs when?", "options": ["Always after try","Only on exceptions","Never","Before try"], "correct": 0 },
        { "q": "open(..., 'a') means?", "options": ["append","write","read","error"], "correct": 0 }
      ]
    },
    {
      "title": "Stage 8 ‚Äî Modules & Libraries",
      "topicShort": "Modules & Libs",
      "lesson": "<p>Import code via <code>import</code> or <code>from ... import ...</code>. Standard modules like <code>math</code> and <code>random</code> are useful.</p><pre>import math\nprint(math.sqrt(25))\nimport random\nprint(random.randint(1,6))</pre>",
      "starter": "# Stage 8: Modules\nimport math\nprint('sqrt(25)=', math.sqrt(25))\nimport random\nprint('dice=', random.randint(1,6))",
      "quiz": [
        { "q": "Import sqrt only?", "options": ["from math import sqrt","import math.sqrt","import sqrt from math","include math.sqrt"], "correct": 0 },
        { "q": "json.dumps gives string?", "options": ["True","False","Depends","Only with indent"], "correct": 0 },
        { "q": "Library for arrays?", "options": ["numpy","pandas","django","flask"], "correct": 0 },
        { "q": "random.randint includes upper?", "options": ["Yes","No","Only sometimes","Depends"], "correct": 0 },
        { "q": "Modules created by .py files?", "options": ["True","False","Only in packages","Only with __init__"], "correct": 0 }
      ]
    },
    {
      "title": "Stage 9 ‚Äî Simple Data Handling",
      "topicShort": "Data Handling",
      "lesson": "<p>Use comprehensions, map/filter, and loops to transform data. This is how you process logs and CSV rows.</p><pre>data=[1,2,3,4,5]\nsquares=[x*x for x in data]\nprint('squares=', squares)</pre>",
      "starter": "# Stage 9: Data handling\ndata = [1,2,3,4,5]\nsquares = [x*x for x in data]\nprint('squares =', squares)\nevens = [x for x in data if x%2==0]\nprint('evens =', evens)",
      "quiz": [
        { "q": "List comprehension example?", "options": ["[x for x in list]","(x for x in list)","{x for x in list}","<x for x>"], "correct": 0 },
        { "q": "map returns?", "options": ["map object","list","string","int"], "correct": 0 },
        { "q": "filter selects items?", "options": ["True","False","Only for sets","No"], "correct": 0 },
        { "q": "reduce reduces to value?", "options": ["True","False","Only numbers","No"], "correct": 0 },
        { "q": "Which creates tuple?", "options": ["(1,2)","[1,2]","{1,2}","<1,2>"], "correct": 0 }
      ]
    },
    {
      "title": "Stage 10 ‚Äî Mini Project & Wrap-up",
      "topicShort": "Mini Project",
      "lesson": "<p>Combine everything: write a small script to process a list and compute a metric. This stage tests integration.</p><pre>nums=[1,2,3,4,5,6]\nevens=[n for n in nums if n%2==0]\nprint('Even count =', len(evens))</pre>",
      "starter": "# Stage 10: Mini project\nnums = [1,2,3,4,5,6,7,8,9,10]\nevens = [n for n in nums if n%2==0]\nprint('Even numbers =', evens)\nprint('Count =', len(evens))",
      "quiz": [
        { "q": "Project checks integration?", "options": ["True","False","Only coding","Only quiz"], "correct": 0 },
        { "q": "Comprehension can replace loops?", "options": ["Yes","No","Only with range","Only in Python 2"], "correct": 0 },
        { "q": "Functions help reuse code?", "options": ["True","False","They slow code","Only for OOP"], "correct": 0 },
        { "q": "Modules organize code?", "options": ["True","False","Only for packages","No"], "correct": 0 },
        { "q": "Final step should be?", "options": ["Stop","Submit progress","Delete files","Rename project"], "correct": 1 }
      ]
    }
  ];

  // ----------------- UTILS -----------------
  function showToast(msg, err=false, t=3000){
    const d = document.createElement('div');
    d.textContent = msg;
    d.className = 'mini-toast';
    d.style.background = err ? '#ff6b6b' : 'linear-gradient(90deg,#00c6ff,#0066ff)';
    d.style.color = err ? '#fff' : '#021';
    document.body.appendChild(d);
    setTimeout(()=>{ d.style.transition = 'all .3s'; d.style.opacity='0'; d.style.transform += ' translateY(8px)'; }, t-300);
    setTimeout(()=>d.remove(), t);
  }

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function nowIso(){ return (new Date()).toISOString(); }

  // ----------------- RENDER STAGES UI -----------------
  function renderStagesList(){
    stagesListEl.innerHTML = '';
    for(let i=0;i<TOTAL_STAGES;i++){
      const pill = document.createElement('div');
      pill.className = 'stage-pill';
      if(i > currentStageIndex) pill.classList.add('locked');
      if(i === currentStageIndex) pill.classList.add('active');
      const short = courseData[i].topicShort || courseData[i].title;
      pill.innerHTML = `Stage ${i+1}: ${escapeHtml(short)}`;
      pill.dataset.index = i;
      if(i <= currentStageIndex){
        pill.addEventListener('click', ()=> loadStage(i));
      }
      stagesListEl.appendChild(pill);
    }
  }

  // ----------------- APPSCRIPT INTERACTIONS (GET / POST) -----------------
  async function fetchProgressFromBackend(email){
    try{
      if(!email) return null;
      const url = APP_SCRIPT_URL + '?email=' + encodeURIComponent(email) + '&course_name=' + encodeURIComponent(COURSE_NAME);
      const res = await fetch(url, { method:'GET', mode:'cors' });
      if(!res.ok){ console.warn('GET backend failed', res.status); return null; }
      const json = await res.json();
      // script returns {status:'success', progress: {...}} or similar
      if(json && json.progress) return json.progress;
      // some scripts return rows array
      if(json && Array.isArray(json.rows) && json.rows.length) return json.rows[0];
      if(json && json.progress) return json.progress;
      // fallback if direct object
      return json;
    }catch(e){
      console.warn('fetchProgress error', e);
      return null;
    }
  }

  async function postProgress(payload){
    try{
      const res = await fetch(APP_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
        mode: 'cors'
      });
      const txt = await res.text();
      let body = null;
      try{ body = JSON.parse(txt); }catch(e){ body = txt; }
      return { ok: res.ok, status: res.status, body };
    }catch(e){
      console.error('postProgress error', e);
      return { ok:false, error:e };
    }
  }

  // ----------------- AUTH -----------------
  function updateSignUi(){
    if(currentUser){
      userNameEl.textContent = currentUser.displayName ? currentUser.displayName.split(' ')[0] : (currentUser.email || 'User');
      signBtn.textContent = 'Sign Out';
      signBtn.onclick = async ()=> {
        try{ await signOut(auth); showToast('Signed out'); }
        catch(e){ console.warn(e); showToast('Sign-out failed', true); }
      };
    } else {
      userNameEl.textContent = 'Guest';
      signBtn.textContent = 'Sign In';
      signBtn.onclick = showSignPopup;
    }
  }

  async function showSignPopup(){
    const provider = new GoogleAuthProvider();
    try{
      await signInWithPopup(auth, provider);
      showToast('Signed in');
    }catch(e){
      console.error('Google sign-in failed', e);
      showToast('Sign-in failed', true);
    }
  }

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    updateSignUi();
    if(user){
      // fetch remote progress and apply
      const row = await fetchProgressFromBackend(user.email);
      if(row){
        const sn = parseInt(row.stage_no || row.stage || row.Stage || 0) || 0;
        const pct = Number(row.percentage || row.Percentage || 0) || 0;
        if(sn > 0){
          progress.stage_no = sn;
          progress.percentage = pct;
          // set currentStageIndex to next unlocked index: if completed N, next index = N (0-based)
          currentStageIndex = Math.min(TOTAL_STAGES - 1, Math.max(0, sn));
        }
        if(progress.stage_no >= TOTAL_STAGES && progress.percentage >= 100){
          locked = true;
          showToast('Course previously completed ‚Äî locked', false);
        }
      }
      renderStagesList();
      updateProgressUI();
      if(progress.stage_no > 0){
        loadStage(Math.max(0, progress.stage_no - 1));
      }
    } else {
      renderStagesList();
      updateProgressUI();
    }
  });

  // ----------------- STAGE LOGIC -----------------
  function updateProgressUI(){
    const displayStage = Math.min(currentStageIndex + 1, TOTAL_STAGES);
    progressTextEl.textContent = `Stage ${displayStage} / ${TOTAL_STAGES}`;
  }

  function loadStage(index){
    if(locked){ showToast('Course completed previously ‚Äî cannot re-take', true); return; }
    if(index > currentStageIndex){ showToast('Stage locked. Complete previous stages first.', true); return; }
    currentStageIndex = index;
    const st = courseData[index];
    lessonTitleEl.innerHTML = `${escapeHtml(st.title)}`;
    lessonContentEl.innerHTML = st.lesson;
    editorEl.value = st.starter;
    outputEl.textContent = '';
    stageStatusEl.textContent = (stageResults[index] && stageResults[index].passed) ? 'Passed' : 'In progress';
    quizArea.style.display = 'none';
    stageScoreEl.textContent = (stageResults[index] && stageResults[index].score !== undefined) ? stageResults[index].score + '%' : '‚Äî';
    renderStagesList();
    updateProgressUI();
  }

  function renderQuiz(index){
    const st = courseData[index];
    quizArea.innerHTML = '';
    quizArea.style.display = 'block';
    const title = document.createElement('div');
    title.style.fontWeight = 700;
    title.style.marginBottom = '8px';
    title.textContent = 'Quiz (5 questions)';
    quizArea.appendChild(title);

    const qWrap = document.createElement('div');
    st.quiz.forEach((q,i)=>{
      const qbox = document.createElement('div');
      qbox.className = 'q';
      const qtitle = document.createElement('div');
      qtitle.style.fontWeight = 600;
      qtitle.textContent = `Q${i+1}. ${q.q}`;
      qbox.appendChild(qtitle);
      const ans = document.createElement('div');
      ans.className = 'answers';
      q.options.forEach((opt,j)=>{
        const label = document.createElement('label');
        label.style.display = 'block';
        label.style.cursor = 'pointer';
        label.style.padding = '6px';
        label.style.borderRadius = '6px';
        label.style.border = '1px solid rgba(255,255,255,0.04)';
        label.style.marginTop = '6px';
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = `q_${index}_${i}`;
        radio.value = j;
        radio.style.marginRight = '8px';
        label.appendChild(radio);
        label.append(document.createTextNode(opt));
        ans.appendChild(label);
      });
      qbox.appendChild(ans);
      qWrap.appendChild(qbox);
    });
    quizArea.appendChild(qWrap);
  }

  // ----------------- PYODIDE SETUP -----------------
  async function loadPyodideAndTools(){
    try{
      pyodide = await loadPyodide();
      pyodideReady = true;
      console.log('Pyodide loaded');
    }catch(e){
      console.error('Pyodide failed to load', e);
      showToast('Failed to load Python runtime', true);
    }
  }
  loadPyodideAndTools();

  // Helper: run Python and capture stdout
  async function runPythonCapture(code){
    if(!pyodideReady) throw new Error('Pyodide not ready');
    // Wrap code to capture stdout and return it
    const wrapper = `
import sys, io, traceback
_output_buf = io.StringIO()
_old_stdout = sys.stdout
_old_stderr = sys.stderr
sys.stdout = _output_buf
sys.stderr = _output_buf
try:
${code.split('\n').map(line => '    ' + line).join('\n')}
except Exception as e:
    import traceback
    traceback.print_exc()
finally:
    sys.stdout = _old_stdout
    sys.stderr = _old_stderr
_out = _output_buf.getvalue()
_out
`;
    try{
      const res = await pyodide.runPythonAsync(wrapper);
      // res is a Python string proxy -> convert to JS string
      return res.toString();
    }catch(e){
      // fallback
      return String(e);
    }
  }

  // ----------------- RUNNER BUTTONS -----------------
  runBtn.addEventListener('click', async ()=>{
    showToast('Running code...');
    outputEl.textContent = '';
    const code = editorEl.value || '';
    try{
      const out = await runPythonCapture(code);
      outputEl.textContent = out || '(no output)';
    }catch(e){
      outputEl.textContent = 'Error: ' + e;
    }
  });

  resetCodeBtn.addEventListener('click', ()=>{
    const st = courseData[currentStageIndex];
    editorEl.value = st.starter;
    outputEl.textContent = '';
  });

  showQuizBtn.addEventListener('click', ()=>{
    renderQuiz(currentStageIndex);
    quizArea.scrollIntoView({behavior:'smooth'});
  });

  // ----------------- QUIZ SUBMISSION & PROGRESS -----------------
  submitQuizBtn.addEventListener('click', ()=>{
    const st = courseData[currentStageIndex];
    const qCount = st.quiz.length;
    let correct = 0;
    for(let i=0;i<qCount;i++){
      const radios = document.getElementsByName(`q_${currentStageIndex}_${i}`);
      let selected = null;
      for(const r of radios){ if(r.checked) selected = Number(r.value); }
      if(selected !== null && selected === st.quiz[i].correct) correct++;
    }
    const pct = Math.round((correct / qCount) * 100);
    stageResults[currentStageIndex] = { score: pct, passed: pct >= PASS_PERCENT, saved:false };
    stageScoreEl.textContent = `${pct}% (${correct}/${qCount})`;
    stageStatusEl.textContent = stageResults[currentStageIndex].passed ? 'Passed' : 'Failed';
    showToast(`Quiz scored ${pct}%`);
  });

  markCompleteBtn.addEventListener('click', async ()=>{
    const res = stageResults[currentStageIndex];
    if(!res){ showToast('Please submit the quiz first', true); return; }
    if(!res.passed){ showToast('Score below passing threshold. Re-try the quiz.', true); return; }
    // compute cumulative percentage average across completed stages
    let sum = 0, count = 0;
    for(let i=0;i<=currentStageIndex;i++){
      if(stageResults[i] && typeof stageResults[i].score === 'number'){ sum += stageResults[i].score; count++; }
    }
    const cumulativePct = count ? Math.round(sum / count) : 0;
    const completedStageNo = currentStageIndex + 1; // 1-based
    progress.stage_no = Math.max(progress.stage_no, completedStageNo);
    progress.percentage = cumulativePct;

    if(!currentUser){
      showToast('Sign in to save progress', true);
      return;
    }

    const payload = {
      name: currentUser.displayName || (currentUser.email || '').split('@')[0] || '',
      email: currentUser.email || '',
      course_name: COURSE_NAME,
      stage_no: progress.stage_no,
      percentage: progress.percentage,
      timestamp: nowIso()
    };

    const posted = await postProgress(payload);
    if(posted.ok){
      showToast('Progress saved to Google Sheet');
      stageResults[currentStageIndex].saved = true;

      // update Firestore small meta (optional)
      try{
        await setDoc(doc(db, 'users', currentUser.uid), { lastCourse: COURSE_NAME, lastCourseAt: serverTimestamp(), lastStage: progress.stage_no }, { merge: true });
      }catch(e){ /* ignore errors here */ }

      // unlock next stage or finish
      if(currentStageIndex < TOTAL_STAGES - 1){
        currentStageIndex++;
      } else {
        // final: compute overall average across all scored stages
        let totalSum = 0, totalCount = 0;
        for(let i=0;i<TOTAL_STAGES;i++){
          if(stageResults[i] && typeof stageResults[i].score === 'number'){ totalSum += stageResults[i].score; totalCount++; }
        }
        const finalPct = totalCount ? Math.round(totalSum / totalCount) : progress.percentage;
        progress.stage_no = TOTAL_STAGES;
        progress.percentage = finalPct;
        await postProgress({ name: currentUser.displayName || '', email: currentUser.email, course_name: COURSE_NAME, stage_no: progress.stage_no, percentage: progress.percentage, timestamp: nowIso() });
        showToast('Course completed! Congratulations üéâ');
        locked = true;
      }
      renderStagesList();
      updateProgressUI();
      loadStage(Math.min(currentStageIndex, TOTAL_STAGES - 1));
    } else {
      console.warn('postProgress failed', posted);
      showToast('Failed saving progress to backend', true);
    }
  });

  // ----------------- START / RESUME -----------------
  startBtn.addEventListener('click', async ()=>{
    if(!currentUser){
      showToast('Please sign in to save & resume progress', false);
      await showSignPopup();
      return;
    }
    const row = await fetchProgressFromBackend(currentUser.email);
    if(row){
      const sn = parseInt(row.stage_no || row.stage || 0) || 0;
      const pct = Number(row.percentage || row.Percentage || 0) || 0;
      progress.stage_no = sn;
      progress.percentage = pct;
      // if last completed stage N, next unlock index should be N
      currentStageIndex = Math.max(0, Math.min(TOTAL_STAGES - 1, sn));
    } else {
      currentStageIndex = 0;
    }
    renderStagesList();
    updateProgressUI();
    loadStage(currentStageIndex);
  });

  overviewBtn.addEventListener('click', ()=>{
    const list = courseData.map((s,i)=> `${i+1}. ${s.title.replace('Stage ' + (i+1) + ' ‚Äî ','')}`).join('\n\n');
    alert('Course overview:\n\n' + list);
  });

  // ----------------- MINI COMPILER UI -----------------
  openCompilerTop.addEventListener('click', ()=>{ miniModal.style.display = 'block'; miniModal.setAttribute('aria-hidden','false'); });
  miniClose.addEventListener('click', ()=>{ miniModal.style.display = 'none'; miniModal.setAttribute('aria-hidden','true'); });
  miniRun.addEventListener('click', async ()=>{
    if(!pyodideReady){ showToast('Python runtime still loading‚Ä¶', true); return; }
    miniOutput.textContent = 'Running...';
    try{
      const out = await runPythonCapture(miniEditor.value || '');
      miniOutput.textContent = out || '(no output)';
    }catch(e){
      miniOutput.textContent = 'Error: ' + e;
    }
  });

  // ----------------- INITIALIZE -----------------
  for(let i=0;i<TOTAL_STAGES;i++) stageResults[i] = null;
  renderStagesList();
  updateProgressUI();
  // prefill editor with stage 1 starter
  editorEl.value = courseData[0].starter;

  // expose debug helpers (optional)
  window._courseData = courseData;
  window._stageResults = stageResults;
  window._runPythonCapture = runPythonCapture;

  // Optional: prevent accidental navigation (commented to keep UX smooth)
  // window.addEventListener('beforeunload', (e)=>{ e.preventDefault(); e.returnValue=''; });

</script>
</body>
</html>
