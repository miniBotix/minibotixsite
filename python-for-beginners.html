<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MiniBotix · Python Beginner — Course</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071126;
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.03);
      --accent1: #007bff;
      --accent2: #00d4ff;
      --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',system-ui,Segoe UI,Roboto,Arial;color:#fff;background:var(--bg);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    header.nav{position:fixed;top:0;left:0;right:0;height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;background:rgba(0,0,0,0.45);backdrop-filter:blur(6px);z-index:90}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:18px}
    .brand img{height:38px;width:38px;border-radius:6px;background:linear-gradient(90deg,#00c6ff,#0066ff)}
    .back-btn{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,0.9);cursor:pointer}
    .top-actions{display:flex;gap:12px;align-items:center}
    .hero{padding:110px 18px 26px 18px}
    .hero-card{max-width:1200px;margin:0 auto;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:28px;border-radius:14px;box-shadow:0 30px 60px rgba(3,7,20,0.6)}
    .eyebrow{display:inline-block;background:rgba(255,255,255,0.03);padding:8px 12px;border-radius:999px;margin-bottom:12px;color:#aee9ff;font-weight:600}
    .hero h1{font-size:30px;margin:6px 0 10px;line-height:1.03}
    .hero p{color:rgba(255,255,255,0.85);margin-bottom:12px;max-width:1000px}
    .progress-pill{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .btn-primary{background:var(--accent-grad);padding:10px 16px;border-radius:999px;border:none;color:#fff;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,0.45)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .section{padding:26px 18px 120px}
    .container{max-width:1200px;margin:0 auto}
    h2{font-size:22px;margin-bottom:10px}
    .lead{color:rgba(255,255,255,0.8);margin-bottom:14px}
    .stage-panel{display:grid;grid-template-columns:1fr 520px;gap:18px;align-items:start}
    .lesson-card{background:var(--card);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .lesson-title{font-size:18px;font-weight:700;margin-bottom:8px}
    .lesson-content{color:rgba(255,255,255,0.95);line-height:1.6}
    .runner-card{background:linear-gradient(180deg,rgba(255,255,255,0.015),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)}
    .editor{width:100%;height:300px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#06101a;padding:10px;color:#fff;font-family:monospace;resize:vertical;overflow:auto}
    .outbox{min-height:120px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#050816;padding:10px;color:#d6f7ff;font-family:monospace;font-size:13px;white-space:pre-wrap;overflow:auto}
    .quiz{margin-top:12px}
    .q{margin-bottom:8px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);background:rgba(255,255,255,0.01)}
    .answers{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .answer-btn{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;cursor:pointer;text-align:left}
    .stage-footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .muted{color:rgba(255,255,255,0.65);font-size:13px}
    .stages-list{display:flex;gap:8px;overflow:auto;padding:8px;margin-bottom:14px}
    .stage-pill{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;white-space:nowrap}
    .stage-pill.locked{opacity:0.32;cursor:not-allowed}
    .mini-toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 22px; padding: 10px 14px; border-radius: 8px; z-index: 9999; font-weight:600 }
    .hidden { display:none !important; }
    @media (max-width:1100px){ .stage-panel{grid-template-columns:1fr} .runner-card{order:2} }
    .lesson-content p { margin: 9px 0; }
    pre.code-example { background:#04101a;padding:10px;border-radius:8px;overflow:auto;color:#cfefff }
    /* quiz radio styling */
    .quiz label { display:block; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); margin-top:6px; cursor:pointer; }
    .quiz input[type="radio"]{ margin-right:8px; }
    /* big output look */
    .outbox .error { color:#ffb3b3; font-weight:700; }
  </style>
</head>
<body>

<!-- HEADER -->
<header class="nav">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="back-btn" onclick="location.href='courses.html'">← Back</div>
    <div class="brand">
      <div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#00d4ff,#0066ff);display:flex;align-items:center;justify-content:center;font-weight:700">PB</div>
      <div style="line-height:1">
        <div style="font-weight:700">MiniBotix</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.6)">Python · Beginner → Advanced</div>
      </div>
    </div>
  </div>

  <div class="top-actions">
    <div id="progressPill" class="progress-pill">Progress: <span id="progressText">Stage 0 / 10</span></div>
    <div style="display:flex;align-items:center;gap:10px">
      <div id="userName" style="font-weight:600;color:rgba(255,255,255,0.9)">Guest</div>
      <button id="signBtn" class="btn-ghost">Sign In</button>
    </div>
  </div>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-card container">
    <div class="eyebrow">MiniBotix · Courses · Python</div>
    <h1>Python for Engineers — Beginner to Advanced</h1>
    <p class="lead">Ten interactive stages. Read the lesson, run examples in your browser (Pyodide), then take a 5-question quiz. Score ≥ 60% to pass a stage and unlock the next. Progress is saved to your Google Sheet.</p>
    <div style="display:flex;gap:12px;align-items:center">
      <button class="btn-primary" id="startBtn">Start / Resume</button>
      <button class="btn-ghost" id="overviewBtn">Course Overview</button>
    </div>
  </div>
</section>

<!-- MAIN -->
<section class="section">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2>Course Stages</h2>
      <div class="muted">Complete stages in order. We'll save your progress to the sheet so you can return anytime.</div>
    </div>

    <div class="stages-list" id="stagesList"></div>

    <div id="mainStageArea" class="stage-panel">
      <div class="lesson-card">
        <div class="lesson-title" id="lessonTitle">Welcome</div>
        <div class="lesson-content" id="lessonContent">
          <p>Press "Start" to begin. When you first open the page you'll be asked for name and email (used to save progress). Each stage contains an explanation, compact examples you can run, and a short quiz — designed to be clear and friendly for learners with limited resources.</p>
          <p>We keep lessons short and example-driven: copy the starter code, tweak it, press Run and observe output in the Output box on the right.</p>
        </div>

        <div style="margin-top:12px">
          <strong>Stage status:</strong> <span id="stageStatus" class="muted">Not started</span>
        </div>
      </div>

      <div class="runner-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:700">Code Runner (Pyodide)</div>
          <div style="display:flex;gap:8px">
            <button id="runBtn" class="btn-ghost">Run</button>
            <button id="resetCodeBtn" class="btn-ghost">Reset</button>
            <button id="showQuizBtn" class="btn-ghost">Show Quiz</button>
          </div>
        </div>

        <textarea id="editor" class="editor" spellcheck="false" aria-label="Python code editor"></textarea>
        <div style="margin-top:8px;font-weight:700">Output</div>
        <div id="output" class="outbox" role="status" aria-live="polite">Program output will appear here</div>

        <div class="quiz" id="quizArea" style="display:none"></div>

        <div class="stage-footer">
          <div>
            <button id="submitQuizBtn" class="btn-primary">Submit Quiz</button>
            <button id="markCompleteBtn" class="btn-ghost">Mark Complete (if passed)</button>
          </div>
          <div class="muted">Stage Score: <span id="stageScore">—</span></div>
        </div>
      </div>
    </div>

  </div>
</section>

<footer style="padding-bottom:40px">
  <div class="container" style="text-align:center">
    <div style="margin-bottom:8px">MiniBotix · Learn · Build · Innovate</div>
    <small>© 2025 MiniBotix</small>
  </div>
</footer>

<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

<script>
/* ==========================
   Configuration & Constants
   ========================== */
const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxApgefcqGK1KLybeyHiVlnbNKDM9oXL0d7-c_MyIsMiv3qvlj6-Og1RTsOU5KrSFGl/exec';
const COURSE_NAME = 'Python Beginner';
const PASS_PERCENT = 60;
const TOTAL_STAGES = 10;

/* ==========================
   UI Refs
   ========================== */
const signBtn = document.getElementById('signBtn');
const userNameEl = document.getElementById('userName');
const startBtn = document.getElementById('startBtn');
const overviewBtn = document.getElementById('overviewBtn');

const stagesListEl = document.getElementById('stagesList');
const lessonTitleEl = document.getElementById('lessonTitle');
const lessonContentEl = document.getElementById('lessonContent');
const stageStatusEl = document.getElementById('stageStatus');
const progressTextEl = document.getElementById('progressText');

const editorEl = document.getElementById('editor');
const runBtn = document.getElementById('runBtn');
const resetCodeBtn = document.getElementById('resetCodeBtn');
const outputEl = document.getElementById('output');

const showQuizBtn = document.getElementById('showQuizBtn');
const quizArea = document.getElementById('quizArea');
const submitQuizBtn = document.getElementById('submitQuizBtn');
const markCompleteBtn = document.getElementById('markCompleteBtn');
const stageScoreEl = document.getElementById('stageScore');

/* ==========================
   App State
   ========================== */
let pyodideReadyPromise = null;
let currentUser = { name: null, email: null }; // stored in localStorage if not using Firebase
let currentStageIndex = 0; // 0-based
let progress = { stage_no: 0, percentage: 0 }; // last completed stage (1-based)
let stageResults = Array(TOTAL_STAGES).fill(null); // {score, passed, saved}
let locked = false;

/* ==========================
   Course Content (10 stages)
   Each stage: title, lesson (HTML), starter (string), quiz: array of {q, a:[], correct}
   ========================== */
const stages = [
  {
    title: 'Stage 1 — Intro & Hello World',
    lesson: `<p><strong>What is Python?</strong> Python is a simple and powerful language. In this stage you will write your first program, learn printing and simple arithmetic.</p>
             <p><strong>Why this matters:</strong> Small scripts help you automate boring tasks and test ideas quickly.</p>
             <pre class="code-example"># Example\nprint("Hello, world!")\nprint("2 + 3 =", 2 + 3)</pre>
             <p>Practice: change the printed name and numbers, then press Run.</p>`,
    starter: `# Stage 1: Hello world & arithmetic\nname = "Student"\nprint("Hello,", name)\nprint("2 + 3 =", 2 + 3)\n# Try: change name or add more prints`,
    quiz: [
      { q:'Which function prints to screen in Python?', a:['echo()','print()','console.log()','output()'], correct:1 },
      { q:'What type is "42" (with quotes)?', a:['int','str','float','bool'], correct:1 },
      { q:'What does print(2*3) show?', a:['5','6','23','Error'], correct:1 },
      { q:'Python file extension?', a:['.py','.js','.java','.txt'], correct:0 },
      { q:'Is Python statically typed?', a:['True','False','Depends','Sometimes'], correct:1 }
    ]
  },

  {
    title: 'Stage 2 — Variables & Types',
    lesson: `<p><strong>Variables</strong> are names for values: numbers, text, true/false. Python figures out types automatically.</p>
             <pre class="code-example">x = 10\ny = 2.5\nname = "MiniBotix"\nprint(type(x), type(y), type(name))</pre>
             <p>Tip: use <code>type()</code> to inspect.</p>`,
    starter: `# Stage 2: Variables & Types\nx = 10\ny = 2.5\nname = "MiniBotix"\nprint("x:", x, "type:", type(x))\nprint("y:", y, "type:", type(y))\nprint("name:", name, "type:", type(name))`,
    quiz: [
      { q:'Which converts "3.14" to float?', a:['int("3.14")','float("3.14")','str(3.14)','None'], correct:1 },
      { q:'Which is a boolean?', a:['"True"','True','1','"1"'], correct:1 },
      { q:'type("hello") is?', a:['int','str','list','bool'], correct:1 },
      { q:'What does // do?', a:['Float division','Modulus','Integer division (floor)','Power'], correct:2 },
      { q:'Which is immutable?', a:['list','dict','str','set'], correct:2 }
    ]
  },

  {
    title: 'Stage 3 — Control Flow (if / else)',
    lesson: `<p>Use <code>if</code>, <code>elif</code>, <code>else</code> to make decisions. Indentation matters in Python.</p>
             <pre class="code-example">x = 7\nif x % 2 == 0:\n    print("even")\nelse:\n    print("odd")</pre>
             <p>Try different values for x.</p>`,
    starter: `# Stage 3: If/else\nx = 7\nif x % 2 == 0:\n    print(x, "is even")\nelif x % 3 == 0:\n    print(x, "divisible by 3")\nelse:\n    print(x, "is odd and not divisible by 3")`,
    quiz: [
      { q:'Which tests equality?', a:['=','==','===',':='], correct:1 },
      { q:'Keyword for alternative branch?', a:['otherwise','elif','elseif','or'], correct:1 },
      { q:'Does indentation matter?', a:['True','False','Only sometimes','No'], correct:0 },
      { q:'What prints for x=10 given if x>5 then A elif x>8 then B?', a:['A','B','Both','Error'], correct:0 },
      { q:'Valid condition?', a:['x = 5','x == 5','if x: 5','if x = 5:'], correct:1 }
    ]
  },

  {
    title: 'Stage 4 — Loops (for & while)',
    lesson: `<p>Loops repeat tasks. <code>for</code> is for sequences, <code>while</code> repeats while a condition holds.</p>
             <pre class="code-example">for i in range(5):\n    print(i)\n\nn = 3\nwhile n>0:\n    print("tick", n)\n    n -= 1</pre>
             <p>Avoid infinite loops by ensuring conditions eventually become false.</p>`,
    starter: `# Stage 4: Loops\nfor i in range(5):\n    print("i =", i)\n\nn = 3\nwhile n>0:\n    print("tick", n)\n    n -= 1`,
    quiz: [
      { q:'How to loop 0..4?', a:['for i in 0..4','for i in range(5)','for (i=0;i<5;i++)','while i<5:'], correct:1 },
      { q:'range(2,5) yields?', a:['0,1,2,3,4','2,3,4','2,3,4,5','Error'], correct:1 },
      { q:'Break exits loop immediately?', a:['Yes','No','Only in while','Only in for'], correct:0 },
      { q:'Continue skips to next iteration?', a:['True','False','Maybe','Only in Python 3'], correct:0 },
      { q:'While needs a counter to avoid infinite loop?', a:['Always','Never','Often yes','Not required'], correct:2 }
    ]
  },

  {
    title: 'Stage 5 — Functions',
    lesson: `<p>Functions group code and can return values. Use <code>def</code> and <code>return</code>.</p>
             <pre class="code-example">def add(a,b):\n    return a + b\nprint(add(3,4))</pre>
             <p>Functions make code reusable and clearer.</p>`,
    starter: `# Stage 5: Functions\ndef add(a,b):\n    return a + b\n\nprint("add(3,4) =", add(3,4))`,
    quiz: [
      { q:'How to define a function?', a:['function x():','def x():','func x():','define x():'], correct:1 },
      { q:'How return a value?', a:['exit','return','yield','send'], correct:1 },
      { q:'Are functions first-class?', a:['Yes','No','Only in 3.8+','Only if decorated'], correct:0 },
      { q:'Default parameter placement?', a:['First','Middle','Last','Anywhere'], correct:2 },
      { q:'Lambda creates anonymous function?', a:['True','False','Only in 3.0','Only for IO'], correct:0 }
    ]
  },

  {
    title: 'Stage 6 — Lists & Dictionaries',
    lesson: `<p>Lists are sequences; dicts map keys to values. Use indexing, append, pop, keys(), values().</p>
             <pre class="code-example">fruits = ['apple','banana']\nfruits.append('cherry')\nprint(fruits)\nperson = {'name':'A','age':20}\nprint(person['name'])</pre>`,
    starter: `# Stage 6: Lists & Dicts\nfruits = ['apple','banana']\nfruits.append('cherry')\nprint('fruits:', fruits)\n\nperson = {'name':'A', 'age':20}\nprint('person name:', person['name'])`,
    quiz: [
      { q:"Access first element of list 'a'?", a:['a(0)','a[0]','a.0','a.first()'], correct:1 },
      { q:'Which creates a dict?', a:["{'k':1}", "['k',1]", "('k',1)", "{'k'}"], correct:0 },
      { q:'append adds to end?', a:['True','False','Maybe','Only for strings'], correct:0 },
      { q:'keys() returns?', a:['list','view','string','int'], correct:1 },
      { q:'pop() removes and returns?', a:['True','False','It raises','No'], correct:0 }
    ]
  },

  {
    title: 'Stage 7 — File I/O & Exceptions',
    lesson: `<p>Files let programs read/write data. Use <code>with open(...)</code> to safely work with files. Use <code>try/except</code> to handle errors.</p>
             <pre class="code-example"># Desktop example\n# with open('out.txt','w') as f:\n#     f.write('hello')\nprint('In browser we won't write files, but this is the pattern.')</pre>`,
    starter: `# Stage 7: File I/O (demo)\nprint("We won't write files in the browser.")\n# Example:\n# with open('out.txt', 'w') as f:\n#     f.write('hello')`,
    quiz: [
      { q:'Open file for reading?', a:["open('f','r')","open('f','w')","open('f','rw')","open('f')"], correct:0 },
      { q:'Context manager auto-closes file?', a:['True','False','Only in 3.10','Only with try'], correct:0 },
      { q:'Which catches exceptions?', a:['try/except','if/error','throw/catch','try/catch'], correct:0 },
      { q:'Finally runs when?', a:['Always after try','Only on exceptions','Never','Before try'], correct:0 },
      { q:'open(..., "a") means?', a:['append','write','read','error'], correct:0 }
    ]
  },

  {
    title: 'Stage 8 — Modules & Libraries',
    lesson: `<p>Modules group code across files. Use <code>import</code> to reuse standard libraries. Popular libs include math, random, json. For heavy tasks use third-party libs (numpy, pandas) in real environments.</p>
             <pre class="code-example">import math\nprint(math.sqrt(25))\nimport random\nprint(random.randint(1,6))</pre>`,
    starter: `# Stage 8: Modules\nimport math\nprint('sqrt(25)=', math.sqrt(25))\n\nimport random\nprint('dice:', random.randint(1,6))`,
    quiz: [
      { q:'How to import sqrt only?', a:['from math import sqrt','import math.sqrt','import sqrt from math','include math.sqrt'], correct:0 },
      { q:'json.dumps ->?', a:['string','number','list','error'], correct:0 },
      { q:'Library for arrays?', a:['numpy','pandas','django','flask'], correct:0 },
      { q:'random.randint(1,3) includes 3?', a:['Yes','No','Only sometimes','Depends'], correct:0 },
      { q:'Create modules by saving .py files?', a:['True','False','Only in packages','Only with __init__'], correct:0 }
    ]
  },

  {
    title: 'Stage 9 — Simple Data Handling',
    lesson: `<p>Use lists, dicts and comprehensions to filter and transform data, a common engineer task.</p>
             <pre class="code-example">data = [1,2,3,4,5]\nsquares = [x*x for x in data]\nprint('squares:', squares)</pre>`,
    starter: `# Stage 9: Data handling\ndata = [1,2,3,4,5]\nsquares = [x*x for x in data]\nprint('squares:', squares)\nevens = [x for x in data if x%2==0]\nprint('evens:', evens)`,
    quiz: [
      { q:'List comprehension syntax?', a:['[x for x in list]','(x for x in list)','{x for x in list}','<x for x>'], correct:0 },
      { q:'map() returns?', a:['map object','list','string','int'], correct:0 },
      { q:'filter selects items?', a:['True','False','Only for sets','No'], correct:0 },
      { q:'reduce reduces sequence?', a:['True','False','Only for numbers','No'], correct:0 },
      { q:'Which creates tuple?', a:["(1,2)","[1,2]","{1,2}","<1,2>"], correct:0 }
    ]
  },

  {
    title: 'Stage 10 — Mini Project & Wrap-up',
    lesson: `<p>Put everything together: process a list, filter and compute a metric. Build small useful scripts — that's the goal.</p>
             <pre class="code-example">nums = [1,2,3,4,5,6]\nevens = [n for n in nums if n%2==0]\nprint('Even count:', len(evens))</pre>
             <p>When you pass this stage and mark complete we will record your final completion and lock the course for your account.</p>`,
    starter: `# Stage 10: Mini project\nnums = [1,2,3,4,5,6,7,8,9,10]\nevens = [n for n in nums if n%2==0]\nprint('Even numbers:', evens)\nprint('Count:', len(evens))`,
    quiz: [
      { q:'Project stage checks integration of topics', a:['True','False','Only coding','Only quiz'], correct:0 },
      { q:'List comprehension can replace loops', a:['Yes','No','Only with range','Only in Python 2'], correct:0 },
      { q:'Functions help reuse code', a:['True','False','They slow code','Only for OOP'], correct:0 },
      { q:'Modules help organize code', a:['True','False','Only for packages','No'], correct:0 },
      { q:'Final step should be', a:['Stop','Submit progress','Delete files','Rename project'], correct:1 }
    ]
  }
];

/* ==========================
   Utilities
   ========================== */
function showToast(msg, err=false, t=3000){
  const d = document.createElement('div');
  d.textContent = msg;
  d.className = 'mini-toast';
  d.style.background = err ? '#ff6b6b' : 'linear-gradient(90deg,#00c6ff,#0066ff)';
  d.style.color = err ? '#fff' : '#021';
  d.style.left = '50%';
  d.style.transform = 'translateX(-50%)';
  document.body.appendChild(d);
  setTimeout(()=>{ d.style.transition='all .35s'; d.style.opacity='0'; d.style.transform += ' translateY(8px)'; }, t-300);
  setTimeout(()=>d.remove(), t);
}
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function nowIso(){ return (new Date()).toISOString(); }

/* ==========================
   Render stages list
   ========================== */
function renderStagesList(){
  stagesListEl.innerHTML = '';
  for(let i=0;i<TOTAL_STAGES;i++){
    const pill = document.createElement('div');
    pill.className = 'stage-pill';
    if(i > currentStageIndex) pill.classList.add('locked');
    const short = stages[i].title.indexOf('—')!==-1 ? stages[i].title.split('—')[1].trim() : stages[i].title;
    pill.innerHTML = `Stage ${i+1}: ${escapeHtml(short)}`;
    pill.dataset.index = i;
    if(i <= currentStageIndex){
      pill.addEventListener('click', ()=> loadStage(i));
    }
    stagesListEl.appendChild(pill);
  }
}

/* ==========================
   Backend: GET / POST to Apps Script
   GET: ?email=...&course_name=...
   POST: JSON {name,email,course_name,stage_no,percentage,timestamp}
   ========================== */
async function fetchProgressFromBackend(email){
  try{
    if(!email) return null;
    const url = APP_SCRIPT_URL + '?email=' + encodeURIComponent(email) + '&course_name=' + encodeURIComponent(COURSE_NAME);
    const res = await fetch(url, { method: 'GET', mode: 'cors' });
    if(!res.ok) { console.warn('GET progress failed', res.status); return null; }
    const j = await res.json();
    // Support shapes: {status:'success', progress: {...}} or {progress:...} or {rows:[...]}
    if(j.progress) return j.progress;
    if(j.rows && Array.isArray(j.rows) && j.rows.length) return j.rows[0];
    if(j.data && Array.isArray(j.data) && j.data.length) return j.data[0];
    // If script returns array of rows (older style)
    if(Array.isArray(j) && j.length) return j[0];
    return null;
  }catch(e){
    console.warn('fetchProgress error', e);
    return null;
  }
}

async function postProgress(payload){
  try{
    const res = await fetch(APP_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
      mode: 'cors'
    });
    const text = await res.text();
    let body = null;
    try{ body = JSON.parse(text); } catch(e){ body = text; }
    return { ok: res.ok, status: res.status, body };
  }catch(e){
    console.error('postProgress error', e);
    return { ok:false, error:e };
  }
}

/* ==========================
   Simple sign-in (name + email)
   Uses localStorage — easy and lightweight.
   If you later want Firebase we can swap this.
   ========================== */
function ensureSignedIn(){
  const storedEmail = localStorage.getItem('mbx_email');
  const storedName = localStorage.getItem('mbx_name');
  if(storedEmail && storedName){
    currentUser.email = storedEmail; currentUser.name = storedName;
    updateSignUi();
    return true;
  }
  // Prompt simple modal-like inputs
  const name = prompt('Enter your name (used to save progress):');
  if(!name){ showToast('Name required to save progress', true); return false; }
  const email = prompt('Enter your email (used to save progress & resume later):');
  if(!email || !email.includes('@')){ showToast('Valid email required', true); return false; }
  localStorage.setItem('mbx_name', name.trim());
  localStorage.setItem('mbx_email', email.trim().toLowerCase());
  currentUser.name = name.trim();
  currentUser.email = email.trim().toLowerCase();
  updateSignUi();
  return true;
}

function updateSignUi(){
  if(currentUser && currentUser.name){
    userNameEl.textContent = currentUser.name.split(' ')[0] || currentUser.email;
    signBtn.textContent = 'Sign Out';
    signBtn.onclick = () => {
      localStorage.removeItem('mbx_name'); localStorage.removeItem('mbx_email');
      currentUser = { name:null, email:null };
      userNameEl.textContent = 'Guest';
      signBtn.textContent = 'Sign In';
      showToast('Signed out');
    };
  } else {
    userNameEl.textContent = 'Guest';
    signBtn.textContent = 'Sign In';
    signBtn.onclick = () => {
      ensureSignedIn();
    };
  }
}

/* ==========================
   Load / Save / Progress logic
   ========================== */
function updateProgressUI(){
  const displayStage = Math.min(currentStageIndex + 1, TOTAL_STAGES);
  progressTextEl.textContent = `Stage ${displayStage} / ${TOTAL_STAGES}`;
  // update status text
  const st = stageResults[currentStageIndex];
  stageStatusEl.textContent = st && st.passed ? 'Passed' : 'In progress';
}

function loadStage(index){
  if(locked){ showToast('Course completed and locked for this account', true); return; }
  if(index > currentStageIndex){ showToast('Stage locked. Complete previous stages first.', true); return; }
  currentStageIndex = index;
  const s = stages[index];
  lessonTitleEl.innerHTML = escapeHtml(s.title);
  lessonContentEl.innerHTML = s.lesson;
  editorEl.value = s.starter;
  outputEl.textContent = '';
  quizArea.style.display = 'none';
  stageScoreEl.textContent = stageResults[index] && stageResults[index].score !== undefined ? stageResults[index].score + '%' : '—';
  renderStagesList();
  updateProgressUI();
  setTimeout(()=> { document.getElementById('mainStageArea').scrollIntoView({behavior:'smooth'}); }, 100);
}

/* Render quiz for current stage inside quizArea */
function renderQuiz(index){
  const s = stages[index];
  quizArea.innerHTML = '';
  quizArea.style.display = 'block';
  const title = document.createElement('div'); title.style.fontWeight='700'; title.style.marginBottom='8px'; title.textContent = `Quiz — ${s.title}`;
  quizArea.appendChild(title);
  const form = document.createElement('div');
  s.quiz.forEach((q,i)=>{
    const qbox = document.createElement('div'); qbox.className = 'q';
    const qtitle = document.createElement('div'); qtitle.style.fontWeight = 600; qtitle.textContent = `Q${i+1}. ${q.q}`;
    qbox.appendChild(qtitle);
    const ansWrap = document.createElement('div'); ansWrap.className = 'answers';
    q.a.forEach((opt,j)=>{
      const id = `q_${index}_${i}_${j}`;
      const label = document.createElement('label');
      const input = document.createElement('input');
      input.type = 'radio'; input.name = `q_${index}_${i}`; input.value = j; input.id = id;
      label.htmlFor = id;
      label.appendChild(input);
      label.appendChild(document.createTextNode(opt));
      ansWrap.appendChild(label);
    });
    qbox.appendChild(ansWrap);
    form.appendChild(qbox);
  });
  quizArea.appendChild(form);
  // scroll
  setTimeout(()=> quizArea.scrollIntoView({behavior:'smooth'}), 120);
}

/* ==========================
   Pyodide runner setup
   ========================== */
async function ensurePyodide(){
  if(pyodideReadyPromise) return pyodideReadyPromise;
  // load Pyodide and keep promise
  pyodideReadyPromise = (async () => {
    showToast('Loading Python runtime (first load may take a few seconds)...');
    const pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/" });
    // You can load micropip / packages if needed later: await pyodide.loadPackage(['micropip']);
    showToast('Python runtime ready');
    return pyodide;
  })();
  return pyodideReadyPromise;
}

/* Run code with Pyodide and capture stdout/stderr */
async function runCode(){
  await ensurePyodide();
  const pyodide = await pyodideReadyPromise;
  outputEl.textContent = '';
  // create a simple stdout capture
  const code = editorEl.value || '';
  const wrapped = `
import sys
from js import console
class _Out:
    def __init__(self):
        self.buf = ""
    def write(self,s):
        try:
            self.buf += str(s)
        except:
            pass
    def flush(self):
        pass
_out = _Out()
orig = sys.stdout
orig_err = sys.stderr
sys.stdout = _out
sys.stderr = _out
try:
${code.split('\n').map(line=>'    '+line).join('\n')}
finally:
    sys.stdout = orig
    sys.stderr = orig_err
_out.buf
`;
  try{
    const res = await pyodide.runPythonAsync(wrapped);
    // res may be bytes or str
    outputEl.textContent = (res === undefined || res === null || res === '') ? '(no output)' : String(res);
  }catch(err){
    // display raw error
    outputEl.innerHTML = `<span class="error">${escapeHtml(String(err))}</span>`;
  }
}

/* ==========================
   Quiz submit and mark complete
   ========================== */
submitQuizBtn.addEventListener('click', ()=> {
  const s = stages[currentStageIndex];
  // collect answers
  let correct = 0;
  for(let i=0;i<s.quiz.length;i++){
    const radios = document.getElementsByName(`q_${currentStageIndex}_${i}`);
    let selected = null;
    for(const r of radios){ if(r.checked) selected = Number(r.value); }
    if(selected !== null && selected === s.quiz[i].correct) correct++;
  }
  const pct = Math.round((correct / s.quiz.length) * 100);
  stageResults[currentStageIndex] = { score: pct, passed: pct >= PASS_PERCENT, saved:false };
  stageScoreEl.textContent = `${pct}% (${correct}/${s.quiz.length})`;
  stageStatusEl.textContent = stageResults[currentStageIndex].passed ? 'Passed' : 'Failed';
  showToast(`Quiz scored ${pct}%`);
});

markCompleteBtn.addEventListener('click', async ()=> {
  const res = stageResults[currentStageIndex];
  if(!res){ showToast('Please submit the quiz first', true); return; }
  if(!res.passed){ showToast('Score below passing threshold. Retake the quiz.', true); return; }
  // compute cumulative average across completed stages
  let sum=0,count=0;
  for(let i=0;i<=currentStageIndex;i++){
    if(stageResults[i] && typeof stageResults[i].score === 'number'){ sum += stageResults[i].score; count++; }
  }
  const cumulativePct = count ? Math.round(sum / count) : 0;
  const completedStageNo = currentStageIndex + 1;
  progress.stage_no = Math.max(progress.stage_no, completedStageNo);
  progress.percentage = cumulativePct;

  if(!currentUser.email){
    const ok = ensureSignedIn();
    if(!ok) return;
  }

  const payload = {
    name: currentUser.name || '',
    email: currentUser.email || '',
    course_name: COURSE_NAME,
    stage_no: progress.stage_no,
    percentage: progress.percentage,
    timestamp: nowIso()
  };

  const post = await postProgress(payload);
  if(post.ok){
    showToast('Progress saved to Google Sheet');
    stageResults[currentStageIndex].saved = true;
    // unlock next stage or finish
    if(currentStageIndex < TOTAL_STAGES -1){
      currentStageIndex++;
    } else {
      // final: compute overall average
      let totalSum=0,totalCount=0;
      for(let i=0;i<TOTAL_STAGES;i++){
        if(stageResults[i] && typeof stageResults[i].score==='number'){ totalSum += stageResults[i].score; totalCount++; }
      }
      const finalPct = totalCount ? Math.round(totalSum/totalCount) : progress.percentage;
      progress.stage_no = TOTAL_STAGES;
      progress.percentage = finalPct;
      await postProgress({ name: currentUser.name||'', email: currentUser.email, course_name: COURSE_NAME, stage_no: progress.stage_no, percentage: progress.percentage, timestamp: nowIso() });
      showToast('Course completed! Congratulations 🎉');
      locked = true;
    }
    renderStagesList();
    updateProgressUI();
    loadStage(Math.min(currentStageIndex, TOTAL_STAGES-1));
  } else {
    showToast('Failed to save progress to backend', true);
    console.warn('postProgress failed', post);
  }
});

/* ==========================
   Show Quiz button: render quiz for current stage
   ========================== */
showQuizBtn.addEventListener('click', ()=> {
  renderQuiz(currentStageIndex);
});

/* ==========================
   Reset code button
   ========================== */
resetCodeBtn.addEventListener('click', ()=> {
  const st = stages[currentStageIndex];
  editorEl.value = st.starter;
  outputEl.textContent = '';
});

/* ==========================
   Run button wiring
   ========================== */
runBtn.addEventListener('click', async ()=> {
  showToast('Running code...');
  await runCode();
});

/* ==========================
   Start / Resume - get progress from backend if user exists
   ========================== */
startBtn.addEventListener('click', async ()=> {
  if(!currentUser.email){
    const ok = ensureSignedIn();
    if(!ok) return;
  }
  // fetch progress row
  const row = await fetchProgressFromBackend(currentUser.email);
  if(row){
    const sn = parseInt(row.stage_no || row.stage || row['Stage'] || 0) || 0;
    const pct = Number(row.percentage || row.percentage || 0) || 0;
    progress.stage_no = sn;
    progress.percentage = pct;
    // If last completed stage is N, next unlock index should be N (0-based)
    currentStageIndex = Math.max(0, Math.min(TOTAL_STAGES-1, sn));
    if(progress.stage_no >= TOTAL_STAGES && progress.percentage >= 100){
      locked = true;
      showToast('Course already completed for this account', false);
    }
  } else {
    currentStageIndex = 0;
  }
  renderStagesList();
  updateProgressUI();
  loadStage(currentStageIndex);
});

/* ==========================
   Overview button
   ========================== */
overviewBtn.addEventListener('click', ()=> {
  const summary = stages.map((s,i)=> `${i+1}. ${s.title}\n${stripHtml(s.lesson).slice(0,180)}...`).join('\n\n');
  alert('Course overview:\n\n' + summary);
});
function stripHtml(html){ return html.replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim(); }

/* ==========================
   Load progress at startup if user stored
   ========================== */
async function initOnLoad(){
  // load user from localStorage if present
  const name = localStorage.getItem('mbx_name');
  const email = localStorage.getItem('mbx_email');
  if(name && email){
    currentUser.name = name; currentUser.email = email;
  }
  updateSignUi();
  renderStagesList();
  updateProgressUI();
  // set editor default from stage 1
  editorEl.value = stages[0].starter;

  // preload pyodide but do not block UI
  ensurePyodide();

  // If user already had progress saved, auto-fetch and resume
  if(currentUser.email){
    const row = await fetchProgressFromBackend(currentUser.email);
    if(row){
      const sn = parseInt(row.stage_no || row.stage || 0) || 0;
      const pct = Number(row.percentage || 0) || 0;
      progress.stage_no = sn; progress.percentage = pct;
      currentStageIndex = Math.max(0, Math.min(TOTAL_STAGES-1, sn));
      if(progress.stage_no > 0){
        loadStage(Math.max(0, progress.stage_no - 1));
      } else {
        loadStage(0);
      }
      if(progress.stage_no >= TOTAL_STAGES && progress.percentage >= 100) locked = true;
    } else {
      loadStage(0);
    }
  } else {
    // not signed in — show stage 0 info
    loadStage(0);
  }
}
initOnLoad();

/* ==========================
   Keyboard shortcuts:
   Ctrl/Cmd+Enter -> Run
   ========================== */
document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
    e.preventDefault();
    runBtn.click();
  }
});

/* ==========================
   Expose for debugging in console
   ========================== */
window._mbx = {
  stages, stageResults, progress, loadStage, runCode, fetchProgressFromBackend, postProgress
};
</script>
</body>
</html>
